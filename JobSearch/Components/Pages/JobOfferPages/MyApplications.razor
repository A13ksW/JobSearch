@page "/my-applications"
@rendermode InteractiveServer
@using System.Security.Claims
@using JobSearch.Data
@using JobSearch.Services
@using Microsoft.AspNetCore.Authorization
@inject IJobOfferService JobOfferService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager NavigationManager
@attribute [Authorize]

<PageTitle>Moje Aplikacje</PageTitle>

<div class="page-container">
    <div class="container">

        @if (isCompany)
        {
            @* === WIDOK DLA FIRMY (Z CZERWONYM X) === *@
            <div class="company-restricted-wrapper animate-fade-up">
                <div class="company-icon-box">
                    @* ZMIANA: Użyto 'bi-x' (najbardziej kompatybilna ikona) i zwiększono czcionkę *@
                    <i class="bi bi-x" style="color: #ef4444; font-size: 5rem;"></i>
                </div>
                <h2 class="company-title-large">Firma nie może aplikować na oferty</h2>
                <p class="company-description">
                    Jesteś zalogowany jako Pracodawca. Funkcja aplikowania jest dostępna tylko dla kont kandydatów (Indywidualnych).
                </p>
                <div class="d-flex gap-3">
                    <a href="/my-offers" class="btn-company-action btn-company-primary">
                        <i class="bi bi-list-task me-2"></i> Zarządzaj moimi ofertami
                    </a>
                    <a href="/" class="btn-company-action btn-company-secondary">
                        Wróć na stronę główną
                    </a>
                </div>
            </div>
        }
        else
        {
            @* === WIDOK DLA KANDYDATA === *@
            <div class="header-section animate-fade-up">
                <h1 class="page-title">Moje Aplikacje</h1>
                <p class="page-subtitle">Śledź status swoich zgłoszeń i historię rekrutacji.</p>
            </div>

            @if (myApplications == null)
            {
                <div class="text-center py-5">
                    <div class="spinner-border text-light" role="status"></div>
                </div>
            }
            else if (!myApplications.Any())
            {
                <div class="empty-state animate-fade-up delay-1">
                    <i class="bi bi-send display-1 mb-3 d-block opacity-50"></i>
                    <h3>Nie wysłałeś jeszcze żadnych aplikacji</h3>
                    <p>Przeglądaj oferty i aplikuj na wymarzone stanowiska.</p>
                    <a href="/offers" class="btn-empty-cta">Przeglądaj Oferty</a>
                </div>
            }
            else
            {
                <div class="applications-grid animate-fade-up delay-1">
                    @foreach (var app in myApplications)
                    {
                        <div class="app-card card-status-@app.Status">

                            <div class="card-header-flex">
                                <div>
                                    <div class="job-title">@app.JobOffer?.Title</div>
                                    <div class="job-company">
                                        <i class="bi bi-building"></i> @app.JobOffer?.CompanyName
                                    </div>
                                </div>
                                <div class="app-date">
                                    @app.ApplicationDate.ToLocalTime().ToString("dd MMM yyyy")
                                </div>
                            </div>

                            <div class="mb-3">
                                <span class="status-badge status-@app.Status">
                                    @app.Status.ToString()
                                </span>
                            </div>

                            @if (app.Status == ApplicationStatus.Zaproszony && !string.IsNullOrEmpty(app.EmployerContactPhone))
                            {
                                <div class="info-box info-box-success">
                                    <i class="bi bi-telephone-fill info-box-icon"></i>
                                    <div>
                                        <small class="d-block text-uppercase fw-bold" style="font-size: 0.7rem; opacity: 0.8;">Kontakt</small>
                                        <strong>@app.EmployerContactPhone</strong>
                                    </div>
                                </div>
                            }

                            <div class="card-footer-actions">
                                <a href="@($"/offer/{app.JobOfferId}?source=applications")" class="btn-action btn-view">
                                    Zobacz Ofertę
                                </a>

                                @if (app.Status == ApplicationStatus.Odrzucony && !string.IsNullOrEmpty(app.RejectionReason))
                                {
                                    <a href="@($"/my-applications/feedback/{app.Id}")" class="btn-action btn-feedback">
                                        <i class="bi bi-chat-left-text-fill"></i> Powód
                                    </a>
                                }
                            </div>

                        </div>
                    }
                </div>
            }
        }
    </div>
</div>

@code {
    private List<JobApplication>? myApplications;
    private string? currentUserId;
    private bool isCompany = false;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        currentUserId = user.FindFirstValue(ClaimTypes.NameIdentifier);

        if (string.IsNullOrEmpty(currentUserId))
        {
            NavigationManager.NavigateTo("Account/Login");
            return;
        }

        isCompany = !user.HasClaim(c => c.Type == "account_type" && c.Value == "Individual");

        if (!isCompany)
        {
            myApplications = await JobOfferService.GetMyApplicationsAsync(currentUserId);
        }
    }
}