@page "/offer/{Id:int}"
@rendermode InteractiveServer
@using System.Security.Claims
@using JobSearch.Data
@using JobSearch.Services
@using Microsoft.AspNetCore.Authorization
@inject IJobOfferService JobOfferService
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>@jobOffer?.Title</PageTitle>

<div class="offer-page-wrapper">
    <div class="container">

        <div class="mb-4 fade-in">
            <a href="/offers" class="btn-back-glass">
                <i class="bi bi-arrow-left me-2"></i> Powrót do listy
            </a>
        </div>

        @if (jobOffer == null)
        {
            <div class="text-center py-5 text-white">
                <div class="spinner-border text-light" role="status"></div>
                <p class="mt-2 opacity-75">Ładowanie oferty...</p>
            </div>
        }
        else
        {
            <div class="row g-5">

                <div class="col-lg-8 fade-in delay-1">
                    <div class="white-card">

                        <div class="border-bottom pb-4 mb-4">
                            <h1 class="offer-header-title">@jobOffer.Title</h1>
                            <div class="offer-header-company">
                                <i class="bi bi-building-fill text-primary"></i>
                                @jobOffer.CompanyName
                            </div>
                        </div>

                        @if (!string.IsNullOrEmpty(feedbackMessage))
                        {
                            <div class="alert @(isError ? "alert-danger" : "alert-success") mb-4 shadow-sm border-0">
                                <i class="bi @(isError ? "bi-exclamation-circle-fill" : "bi-check-circle-fill") me-2"></i>
                                @feedbackMessage
                            </div>
                        }

                        <div class="section-label"><i class="bi bi-file-earmark-text"></i> Opis stanowiska</div>
                        <div class="section-text">
                            @((MarkupString)jobOffer.Description.Replace("\n", "<br />"))
                        </div>

                        <div class="section-label"><i class="bi bi-list-check"></i> Wymagania</div>
                        <div class="section-text">
                            @((MarkupString)jobOffer.Requirements.Replace("\n", "<br />"))
                        </div>

                        @if (!string.IsNullOrEmpty(jobOffer.Benefits))
                        {
                            <div class="section-label"><i class="bi bi-gift"></i> Benefity</div>
                            <div class="section-text">@jobOffer.Benefits</div>
                        }

                        <div class="section-label"><i class="bi bi-stars"></i> Dodatkowe informacje</div>

                        <div class="tags-container">
                            <span class="tag-badge">
                                <i class="bi bi-briefcase"></i> Doświadczenie: @(jobOffer.RequiresExperience ? "Wymagane" : "Niewymagane")
                            </span>
                            <span class="tag-badge">
                                <i class="bi bi-laptop"></i> Rekrutacja Online: @(jobOffer.IsOnlineRecruitment ? "Tak" : "Nie")
                            </span>

                            @if (jobOffer.RequiresSanitaryBook)
                            {
                                <span class="tag-badge"><i class="bi bi-clipboard-pulse"></i> Sanepid</span>
                            }
                            @if (jobOffer.RequiresStudentStatus)
                            {
                                <span class="tag-badge"><i class="bi bi-mortarboard"></i> Student</span>
                            }
                            @if (jobOffer.RequiresDisabilityCertificate)
                            {
                                <span class="tag-badge"><i class="bi bi-person-wheelchair"></i> Orzeczenie</span>
                            }
                        </div>

                    </div>
                </div>

                <div class="col-lg-4 fade-in delay-2">
                    <div class="sidebar-sticky">
                        <div class="white-card" style="padding: 2rem;">
                            <div class="salary-box">
                                <div class="text-uppercase text-muted small fw-bold mb-1">Wynagrodzenie</div>
                                <div class="salary-value">@jobOffer.SalaryRange</div>
                                <div class="small text-muted">PLN / mies.</div>
                            </div>

                            <div class="mb-4">
                                <div class="info-row">
                                    <i class="bi bi-geo-alt-fill"></i>
                                    <span>Lokalizacja - <strong>@jobOffer.Location</strong></span>
                                </div>
                                @if (jobOffer.IndustryCategory.HasValue)
                                {
                                    <div class="info-row">
                                        <i class="bi bi-tag-fill"></i>
                                        <span>Branża - <strong>@jobOffer.IndustryCategory</strong></span>
                                    </div>
                                }
                                <div class="info-row">
                                    <i class="bi bi-clock-fill"></i>
                                    <span>Wymiar - <strong>@jobOffer.EmplType</strong></span>
                                </div>
                                <div class="info-row">
                                    <i class="bi bi-pc-display-horizontal"></i>
                                    <span>Tryb - <strong>@jobOffer.JobType</strong></span>
                                </div>
                                <div class="info-row">
                                    <i class="bi bi-calendar3"></i>
                                    <span>Publikacja - <strong>@jobOffer.DatePosted.ToShortDateString()</strong></span>
                                </div>
                                <div class="info-row">
                                    <i class="bi bi-hourglass-split"></i>
                                    <span>
                                        Ważne do -
                                        @if (jobOffer.ApplicationDeadline.HasValue)
                                        {
                                            <span class="text-danger fw-bold">@jobOffer.ApplicationDeadline.Value.ToShortDateString()</span>
                                        }
                                        else
                                        {
                                            <span>Bezterminowo</span>
                                        }
                                    </span>
                                </div>
                            </div>

                            <AuthorizeView>
                                <Authorized>
                                    @if (currentUserId != jobOffer.CreatedByUserId)
                                    {
                                        @if (hasApplied)
                                        {
                                            <button class="btn-apply-now disabled">
                                                <i class="bi bi-check-circle-fill me-2"></i> Aplikacja wysłana
                                            </button>
                                        }
                                        else
                                        {
                                            <button class="btn-apply-now" @onclick="Apply">
                                                Aplikuj teraz
                                            </button>
                                        }
                                    }
                                    else
                                    {
                                        <div class="alert alert-secondary text-center m-0 border-0 fw-bold">
                                            To Twoja oferta
                                        </div>
                                    }
                                </Authorized>
                                <NotAuthorized>
                                    <a href="@loginUrl" class="btn btn-outline-primary w-100 rounded-pill fw-bold py-2">
                                        Zaloguj się, aby aplikować
                                    </a>
                                </NotAuthorized>
                            </AuthorizeView>

                        </div>
                    </div>
                </div>

            </div>
        }
    </div>
</div>

@code {
    [Parameter]
    public int Id { get; set; }

    private JobOffer? jobOffer;
    private string? currentUserId;
    private bool hasApplied = false;
    private string loginUrl = string.Empty;
    private string? feedbackMessage;
    private bool isError;

    protected override async Task OnInitializedAsync()
    {
        loginUrl = $"Account/Login?returnUrl={NavigationManager.ToBaseRelativePath(NavigationManager.Uri)}";

        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        currentUserId = authState.User.FindFirstValue(ClaimTypes.NameIdentifier);

        jobOffer = await JobOfferService.GetByIdAsync(Id);

        if (jobOffer == null || (jobOffer.Status != OfferStatus.Opublikowana && jobOffer.CreatedByUserId != currentUserId && !authState.User.IsInRole("Admin")))
        {
            NavigationManager.NavigateTo("/offers");
            return;
        }

        if (!string.IsNullOrEmpty(currentUserId))
        {
            hasApplied = await JobOfferService.HasUserAppliedAsync(Id, currentUserId);
        }
    }

    private async Task Apply()
    {
        if (string.IsNullOrEmpty(currentUserId) || jobOffer == null)
        {
            NavigationManager.NavigateTo(loginUrl);
            return;
        }

        try
        {
            bool success = await JobOfferService.ApplyForOfferAsync(jobOffer.Id, currentUserId);

            if (success)
            {
                feedbackMessage = "Twoja aplikacja została wysłana pomyślnie!";
                isError = false;
                hasApplied = true;
            }
            else
            {
                feedbackMessage = "Wystąpił błąd (już aplikowałeś lub to Twoja oferta).";
                isError = true;
            }
        }
        catch (Exception ex)
        {
            feedbackMessage = $"Błąd serwera: {ex.Message}";
            isError = true;
        }
        StateHasChanged();
    }
}