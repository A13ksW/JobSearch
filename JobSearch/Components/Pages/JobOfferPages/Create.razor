@page "/joboffers/create"
@using JobSearch.Data
@using JobSearch.Services
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity

@inject NavigationManager NavigationManager
@inject IJobOfferService JobOfferService
@inject INipValidationService NipValidationService
@inject IGeoLocationService GeoLocationService

@rendermode InteractiveServer
@attribute [Authorize]

<PageTitle>Stwórz nową ofertę</PageTitle>

<div class="page-card p-4">
    <h3 class="card-title mb-4">Dodaj nową ofertę pracy</h3>
    <p class="text-muted">Po dodaniu, Twoja oferta zostanie przesłana do weryfikacji przez moderatora.</p>
    <hr />

    <EditForm method="post" Model="JobOffer" OnValidSubmit="AddJobOffer" FormName="create" Enhance>
        <DataAnnotationsValidator />
        <ValidationSummary class="text-danger" role="alert" />

        <h5 class="mb-3 text-primary">Dane firmy</h5>
        <div class="row g-3">
            <div class="col-md-6">
                <label for="nip" class="form-label">NIP Firmy</label>
                <div class="input-group">
                    <InputText id="nip" @bind-Value="JobOffer.Nip" class="form-control" aria-required="true" maxlength="10" ReadOnly="@isNipVerified" />
                    <button class="btn btn-secondary" type="button" @onclick="HandleNipValidation" disabled="@(isNipValidating || isNipVerified)">
                        @if (isNipValidating)

                        {
                            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                        }

                        else

                        {
                            <span>Weryfikuj NIP</span>
                        }
                    </button>
                </div>
                <ValidationMessage For="() => JobOffer.Nip" class="text-danger" />
                @if (!string.IsNullOrEmpty(nipValidationMessage))
                {
                    <div class="alert @(isNipVerified ? "alert-success" : "alert-danger") mt-2 p-2 small">
                        @nipValidationMessage
                    </div>
                }
            </div>

            <div class="col-md-6">
                <label for="companyname" class="form-label">Nazwa firmy (automatycznie)</label>
                <InputText id="companyname" @bind-Value="JobOffer.CompanyName" class="form-control" aria-required="true" maxlength="500" ReadOnly="true" />
                <ValidationMessage For="() => JobOffer.CompanyName" class="text-danger" />
            </div>

            <div class="col-md-6">
                <label class="form-label">Branża</label>
                <InputSelect class="form-select" @bind-Value="JobOffer.IndustryCategory">
                    <option value="">-- wybierz branżę --</option>
                    @foreach (IndustryCategory category in Enum.GetValues(typeof(IndustryCategory)))
                    {

                        if (category == IndustryCategory.None) continue;
                        <option value="@category">@GetIndustryLabel(category)</option>
                    }
                </InputSelect>
            </div>
        </div>

        <hr class="my-4" />

        <h5 class="mb-3 text-primary">Szczegóły oferty</h5>
        <div class="mb-3">
            <label for="title" class="form-label">Tytuł stanowiska</label>
            <InputText id="title" @bind-Value="JobOffer.Title" class="form-control" aria-required="true" maxlength="80" />
            <ValidationMessage For="() => JobOffer.Title" class="text-danger" />
        </div>

        <div class="mb-3">
            <label for="description" class="form-label">Opis stanowiska</label>
            <InputTextArea id="description" @bind-Value="JobOffer.Description" class="form-control" rows="5" aria-required="true" maxlength="500" />
            <ValidationMessage For="() => JobOffer.Description" class="text-danger" />
        </div>

        <div class="row g-3 mb-3">
            <div class="col-md-6">
                <label for="offerLocation" class="form-label">Lokalizacja</label>
                <div class="position-relative">
                    <input id="offerLocation"
                           class="form-control @(!string.IsNullOrEmpty(locationValidationMessage) ? "is-invalid" : "")"
                           value="@JobOffer.Location"
                           placeholder="np. Warszawa lub Zdalnie"
                           maxlength="100"
                           @oninput="OnOfferLocationInput"
                           @onfocus="ShowOfferLocationSuggestions"
                           @onblur="HideOfferLocationSuggestionsDelayed" />

                    @if (showOfferLocationSuggestions && offerLocationSuggestions.Any())

                    {
                        <ul class="list-group position-absolute w-100 shadow-sm" style="z-index:1000; max-height:250px; overflow-y:auto;">
                            @foreach (var suggestion in offerLocationSuggestions)

                            {
                                <li class="list-group-item list-group-item-action" style="cursor:pointer" @onmousedown="@(() => SelectOfferLocationSuggestion(suggestion))">
                                    @suggestion
                                </li>
                            }
                        </ul>
                    }
                    @if (!string.IsNullOrEmpty(locationValidationMessage))

                    {
                        <div class="invalid-feedback d-block">@locationValidationMessage</div>
                    }
                </div>
                <ValidationMessage For="() => JobOffer.Location" class="text-danger" />
            </div>

            <div class="col-md-6">
                <label for="contactinfo" class="form-label">Email kontaktowy</label>
                <InputText id="contactinfo" @bind-Value="JobOffer.ContactInfo" class="form-control" aria-required="true" maxlength="250" />
                <ValidationMessage For="() => JobOffer.ContactInfo" class="text-danger" />
            </div>
        </div>

        <div class="row g-3 mb-3">
            <div class="col-md-4">
                <label for="empltype" class="form-label">Rodzaj zatrudnienia</label>
                <InputSelect id="empltype" @bind-Value="JobOffer.EmplType" class="form-control" aria-required="true">
                    <option value="">-- wybierz --</option>
                    @foreach (var type in Enum.GetValues(typeof(EmploymentType)).Cast<EmploymentType>())
                    {
                        <option value="@type">@type</option>
                    }
                </InputSelect>
                <ValidationMessage For="() => JobOffer.EmplType" class="text-danger" />
            </div>

            <div class="col-md-4">
                <label for="jobtype" class="form-label">Tryb pracy</label>
                <InputSelect id="jobtype" @bind-Value="JobOffer.JobType" class="form-control">
                    <option value="">-- wybierz --</option>
                    @foreach (var type in Enum.GetValues(typeof(JobType)).Cast<JobType>())
                    {
                        <option value="@type">@type</option>
                    }
                </InputSelect>
                <ValidationMessage For="() => JobOffer.JobType" class="text-danger" />
            </div>

            <div class="col-md-4">
                <label for="applicationdeadline" class="form-label">Ważna do</label>
                <InputDate id="applicationdeadline" @bind-Value="JobOffer.ApplicationDeadline" class="form-control" min="@today" />
                <ValidationMessage For="() => JobOffer.ApplicationDeadline" class="text-danger" />
            </div>
        </div>

        <div class="row g-3 mb-3">
            <div class="col-md-6">
                <label for="salarymin" class="form-label">Wynagrodzenie (min)</label>
                <InputNumber id="salarymin" @bind-Value="JobOffer.SalaryMin" class="form-control" />
                <ValidationMessage For="() => JobOffer.SalaryMin" class="text-danger" />
            </div>
            <div class="col-md-6">
                <label for="salarymax" class="form-label">Wynagrodzenie (max)</label>
                <InputNumber id="salarymax" @bind-Value="JobOffer.SalaryMax" class="form-control" />
                <ValidationMessage For="() => JobOffer.SalaryMax" class="text-danger" />
            </div>
        </div>

        <hr class="my-4" />

        <h5 class="mb-3 text-primary">Wymagania i Benefity</h5>

        <div class="mb-3">
            <label for="requirements" class="form-label">Wymagania</label>
            <InputTextArea id="requirements" @bind-Value="JobOffer.Requirements" class="form-control" rows="5" aria-required="true" maxlength="500" />
            <ValidationMessage For="() => JobOffer.Requirements" class="text-danger" />
        </div>

        <div class="mb-3">
            <label class="form-label fw-bold">Dodatkowe opcje (zaznacz):</label>
            <div class="d-flex flex-wrap gap-3">
                <div class="form-check">
                    <InputCheckbox id="reqExp" @bind-Value="JobOffer.RequiresExperience" class="form-check-input" />
                    <label class="form-check-label" for="reqExp">Wymagane doświadczenie</label>
                </div>
                <div class="form-check">
                    <InputCheckbox id="isOnline" @bind-Value="JobOffer.IsOnlineRecruitment" class="form-check-input" />
                    <label class="form-check-label" for="isOnline">Rekrutacja online</label>
                </div>
                <div class="form-check">
                    <InputCheckbox id="reqSanitary" @bind-Value="JobOffer.RequiresSanitaryBook" class="form-check-input" />
                    <label class="form-check-label" for="reqSanitary">Książeczka sanepid.</label>
                </div>
                <div class="form-check">
                    <InputCheckbox id="reqStudent" @bind-Value="JobOffer.RequiresStudentStatus" class="form-check-input" />
                    <label class="form-check-label" for="reqStudent">Status studenta</label>
                </div>
                <div class="form-check">
                    <InputCheckbox id="reqDisability" @bind-Value="JobOffer.RequiresDisabilityCertificate" class="form-check-input" />
                    <label class="form-check-label" for="reqDisability">Orzeczenie o niepełnosp.</label>
                </div>
            </div>
        </div>

        <div class="mb-3">
            <label for="benefits" class="form-label">Benefity (opcjonalnie)</label>
            <InputText id="benefits" @bind-Value="JobOffer.Benefits" class="form-control" maxlength="200" />
            <ValidationMessage For="() => JobOffer.Benefits" class="text-danger" />
        </div>

        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
            <a href="/my-offers" class="btn btn-outline-secondary me-md-2">Anuluj</a>
            <button type="submit" class="btn btn-primary" disabled="@(!isNipVerified)">Wyślij do weryfikacji</button>
        </div>
    </EditForm>
</div>

@code {
    [SupplyParameterFromForm]

    private JobOffer JobOffer { get; set; } = new();



    // Zmienne pomocnicze

    private string today = DateTime.Now.ToString("yyyy-MM-dd");

    private bool isNipValidating = false;

    private bool isNipVerified = false;

    private string? nipValidationMessage;

    private string? locationValidationMessage; // Nowa zmienna na błąd lokalizacji



    // Zmienne do autouzupełniania lokalizacji

    private List<string> offerLocationSuggestions = new();

    private bool showOfferLocationSuggestions = false;



    protected override void OnInitialized()

    {

        // Nie ustawiamy deadline na null, bo jest required

    }



    // --- WALIDACJA NIP ---

    private async Task HandleNipValidation()

    {

        isNipValidating = true;

        nipValidationMessage = null;

        StateHasChanged();



        var result = await NipValidationService.ValidateNipAsync(JobOffer.Nip);



        if (result.IsSuccess && result.CompanyName != null)

        {

            isNipVerified = true;

            JobOffer.CompanyName = result.CompanyName;

            nipValidationMessage = $"Zweryfikowano: {result.CompanyName}";

        }

        else

        {

            isNipVerified = false;

            nipValidationMessage = result.ErrorMessage ?? "Błąd weryfikacji NIP.";

        }



        isNipValidating = false;

        StateHasChanged();

    }



    // --- AUTOUZUPEŁNIANIE LOKALIZACJI ---

    private async Task OnOfferLocationInput(ChangeEventArgs e)

    {

        var text = e.Value?.ToString() ?? string.Empty;

        JobOffer.Location = text;

        locationValidationMessage = null; // Czyścimy błąd przy wpisywaniu



        if (!string.IsNullOrWhiteSpace(text) && text.Length >= 2)

        {

            var suggestions = await GeoLocationService.SuggestLocationsAsync(text, 10);

            offerLocationSuggestions = suggestions.Select(s => s.DisplayName).Distinct().ToList();

            showOfferLocationSuggestions = offerLocationSuggestions.Any();

        }

        else

        {

            offerLocationSuggestions.Clear();

            showOfferLocationSuggestions = false;

        }

    }



    private void ShowOfferLocationSuggestions()

    {

        if (offerLocationSuggestions.Any()) showOfferLocationSuggestions = true;

    }



    private async Task HideOfferLocationSuggestionsDelayed()

    {

        await Task.Delay(200);

        showOfferLocationSuggestions = false;

        StateHasChanged();

    }



    private void SelectOfferLocationSuggestion(string suggestion)

    {

        JobOffer.Location = suggestion;

        showOfferLocationSuggestions = false;

        locationValidationMessage = null; // Poprawny wybór

    }



    // --- ZAPIS Z WALIDACJĄ LOKALIZACJI ---

    private async Task AddJobOffer()

    {

        if (!isNipVerified)

        {

            nipValidationMessage = "Wymagana weryfikacja NIP.";

            return;

        }



        // WALIDACJA LOKALIZACJI

        // Sprawdzamy, czy wpisany tekst jest poprawnym miastem w bazie

        if (string.IsNullOrWhiteSpace(JobOffer.Location))

        {

            locationValidationMessage = "Lokalizacja jest wymagana.";

            return;

        }



        var suggestions = await GeoLocationService.SuggestLocationsAsync(JobOffer.Location, 10);

        // Sprawdzamy, czy wpisany tekst jest równy któremukolwiek z wyników (case insensitive)

        var isValidLocation = suggestions.Any(s => s.DisplayName.Equals(JobOffer.Location, StringComparison.OrdinalIgnoreCase));



        if (!isValidLocation)

        {

            locationValidationMessage = "Wybierz poprawną miejscowość z listy podpowiedzi.";

            return;

        }



        await JobOfferService.CreateAsync(JobOffer);

        NavigationManager.NavigateTo("/my-offers");

    }



    // --- HELPER BRANŻY ---

    private string GetIndustryLabel(IndustryCategory category) => category switch

    {

        IndustryCategory.Sprzedaz => "Sprzedaż",

        IndustryCategory.Marketing => "Marketing",

        IndustryCategory.IT => "IT",

        IndustryCategory.Finanse => "Finanse",

        _ => category.ToString()

    };
}