@page "/my-offers/details/{Id:int}"
@rendermode InteractiveServer
@using System.Security.Claims
@using JobSearch.Data
@using JobSearch.Services
@using Microsoft.AspNetCore.Authorization
@inject IJobOfferService JobOfferService
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@attribute [Authorize]

<PageTitle>Zarządzaj Ofertą</PageTitle>

<div class="page-container">

    <div class="top-bar animate-fade-up">
        <a href="/my-offers" class="btn-back-glass">
            <i class="bi bi-arrow-left me-2"></i> Wróć do ofert
        </a>
    </div>

    @if (jobOffer == null)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-light" role="status"></div>
        </div>
    }
    else
    {
        <div class="offer-summary-card animate-fade-up delay-1">
            <div class="d-flex justify-content-between align-items-start mb-3">
                <div>
                    <h1 class="offer-title">@jobOffer.Title</h1>
                    <div class="offer-company">@jobOffer.CompanyName</div>
                </div>
                <span class="status-badge status-@jobOffer.Status">
                    @jobOffer.Status.ToString()
                </span>
            </div>

            @if (jobOffer.Status == OfferStatus.Odrzucona && !string.IsNullOrEmpty(jobOffer.ModerationComment))
            {
                <div class="alert alert-danger p-2 mb-3 small rounded-3 border-0">
                    <strong>Powód odrzucenia:</strong> @jobOffer.ModerationComment
                </div>
            }

            <div class="offer-stats-grid">
                <div class="stat-item">
                    <span class="stat-label">Lokalizacja</span>
                    <span class="stat-value">@jobOffer.Location</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Wynagrodzenie</span>
                    <span class="stat-value text-success">@jobOffer.SalaryRange</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Aplikacje</span>
                    <span class="stat-value fw-bold text-primary">@applications.Count</span>
                </div>
            </div>
        </div>

        <div class="animate-fade-up delay-2">
            <div class="section-header">
                <h3 class="section-title">Kandydaci</h3>
            </div>

            @if (!applications.Any())
            {
                <div class="empty-state">
                    <h4>Brak aplikacji</h4>
                    <p>Nikt jeszcze nie aplikował na to stanowisko.</p>
                </div>
            }
            else
            {
                <div class="applications-list">
                    @foreach (JobSearch.Data.JobApplication app in applications)
                    {
                        <div class="applicant-card">

                            <div class="applicant-header" @onclick="() => ToggleDetails(app.ApplicantId)">
                                <div class="applicant-info">
                                    <div class="avatar-circle">
                                        @GetInitials(app.Applicant?.DisplayName)
                                    </div>
                                    <div>
                                        <div class="applicant-name">@app.Applicant?.DisplayName</div>
                                        <div class="applicant-meta">
                                            @app.ApplicationDate.ToLocalTime().ToString("dd.MM.yyyy HH:mm")
                                        </div>
                                    </div>
                                </div>

                                <div class="applicant-actions-summary">
                                    <span class="app-status app-status-@app.Status">
                                        @app.Status.ToString()
                                    </span>
                                    <button class="btn-toggle @(expandedApplicantId == app.ApplicantId ? "active" : "")">
                                        <i class="bi bi-chevron-down"></i>
                                    </button>
                                </div>
                            </div>

                            @if (expandedApplicantId == app.ApplicantId)
                            {
                                <div class="applicant-details">
                                    @if (app.Applicant?.UserProfileCV == null)
                                    {
                                        <div class="text-muted text-center py-3 border rounded bg-white">
                                            Kandydat nie uzupełnił profilu CV.
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="cv-grid">

                                            <div class="cv-box-container">
                                                <span class="cv-label">Email</span>
                                                <span class="cv-value small">@app.Applicant.Email</span>
                                            </div>
                                            <div class="cv-box-container">
                                                <span class="cv-label">Doświadczenie</span>
                                                <span class="cv-value">@GetExperienceLabel(app.Applicant.UserProfileCV.ExperienceYears)</span>
                                            </div>
                                            <div class="cv-box-container">
                                                <span class="cv-label">Status Edukacji</span>
                                                <span class="cv-value">@app.Applicant.UserProfileCV.EducationStatus</span>
                                            </div>

                                            <div class="cv-box-container">
                                                <span class="cv-label">Uczelnia</span>
                                                <span class="cv-value">@(string.IsNullOrEmpty(app.Applicant.UserProfileCV.University) ? "-" : app.Applicant.UserProfileCV.University)</span>
                                            </div>
                                            <div class="cv-box-container">
                                                <span class="cv-label">Kierunek</span>
                                                <span class="cv-value">@(string.IsNullOrEmpty(app.Applicant.UserProfileCV.FieldOfStudy) ? "-" : app.Applicant.UserProfileCV.FieldOfStudy)</span>
                                            </div>

                                            <div class="cv-box-container">
                                                <span class="cv-label">Praca Zdalna</span>
                                                <span class="cv-value">@app.Applicant.UserProfileCV.RemoteWork</span>
                                            </div>
                                            <div class="cv-box-container">
                                                <span class="cv-label">Relokacja</span>
                                                <span class="cv-value">@app.Applicant.UserProfileCV.Relocation</span>
                                            </div>
                                            <div class="cv-box-container">
                                                <span class="cv-label">Preferowane Kategorie</span>
                                                <span class="cv-value small">@(string.IsNullOrEmpty(app.Applicant.UserProfileCV.PreferredCategories) ? "-" : app.Applicant.UserProfileCV.PreferredCategories)</span>
                                            </div>
                                            <div class="cv-box-container">
                                                <span class="cv-label">Preferowane Działy</span>
                                                <span class="cv-value small">@(string.IsNullOrEmpty(app.Applicant.UserProfileCV.PreferredDepartments) ? "-" : app.Applicant.UserProfileCV.PreferredDepartments)</span>
                                            </div>
                                            <div class="cv-box-container">
                                                <span class="cv-label">Preferowane Lokalizacje</span>
                                                <span class="cv-value small">@(string.IsNullOrEmpty(app.Applicant.UserProfileCV.PreferredLocations) ? "-" : app.Applicant.UserProfileCV.PreferredLocations)</span>
                                            </div>

                                            <div class="cv-box-container" style="grid-column: 1 / -1;">
                                                <span class="cv-label">Umiejętności</span>
                                                <div class="tags-wrapper">
                                                    @if (app.Applicant.UserProfileCV.Skills.Any())
                                                    {
                                                        @foreach (var skill in app.Applicant.UserProfileCV.Skills)
                                                        {
                                                            <span class="cv-tag">@skill.SkillName</span>
                                                        }
                                                    }
                                                    else
                                                    {
                                                        <span class="text-muted small">-</span>
                                                    }
                                                </div>
                                            </div>

                                            <div class="cv-box-container" style="grid-column: 1 / -1;">
                                                <span class="cv-label">Języki</span>
                                                <div class="tags-wrapper">
                                                    @if (app.Applicant.UserProfileCV.Languages.Any())
                                                    {
                                                        @foreach (var lang in app.Applicant.UserProfileCV.Languages)
                                                        {
                                                            <span class="cv-tag">@lang.LanguageName (@lang.LanguageLevel)</span>
                                                        }
                                                    }
                                                    else
                                                    {
                                                        <span class="text-muted small">-</span>
                                                    }
                                                </div>
                                            </div>

                                            <div class="cv-box-container" style="grid-column: 1 / -1;">
                                                <span class="cv-label">Załączniki</span>
                                                <div class="d-flex gap-3">
                                                    @if (!string.IsNullOrEmpty(app.Applicant.UserProfileCV.CvFileUrl))
                                                    {
                                                        <a href="@app.Applicant.UserProfileCV.CvFileUrl" target="_blank" class="btn-link text-decoration-none fw-bold"><i class="bi bi-file-earmark-pdf me-1"></i> Pobierz CV</a>
                                                    }
                                                    @if (!string.IsNullOrEmpty(app.Applicant.UserProfileCV.LinkedInUrl))
                                                    {
                                                        <a href="@app.Applicant.UserProfileCV.LinkedInUrl" target="_blank" class="btn-link text-decoration-none fw-bold"><i class="bi bi-linkedin me-1"></i> LinkedIn</a>
                                                    }
                                                </div>
                                            </div>
                                        </div>
                                    }

                                    <div class="actions-panel">
                                        @if (!string.IsNullOrEmpty(errorMessage) && errorAppId == app.Id)
                                        {
                                            <div class="alert alert-danger py-2 px-3 mb-3 small rounded-3 border-0">
                                                @errorMessage
                                            </div>
                                        }

                                        @if (app.Status == ApplicationStatus.Aplikowano)
                                        {
                                            <div class="d-flex gap-3">
                                                <button class="btn-action btn-invite flex-grow-1" @onclick="() => ToggleAction(app.Id, ActionType.Invite)">
                                                    Zaproś na rozmowę
                                                </button>
                                                <button class="btn-action btn-reject flex-grow-1" @onclick="() => ToggleAction(app.Id, ActionType.Reject)">
                                                    Odrzuć
                                                </button>
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    @if (app.Status == ApplicationStatus.Zaproszony)
                                                    {
                                                        <div class="small text-success fw-bold">Wysłano zaproszenie</div>
                                                    }
                                                    @if (app.Status == ApplicationStatus.Odrzucony)
                                                    {
                                                        <div class="small text-danger">Aplikacja odrzucona</div>
                                                    }
                                                </div>

                                                @if (CanChangeDecision(app))
                                                {
                                                    @if (app.Status == ApplicationStatus.Odrzucony)
                                                    {
                                                        <button class="btn btn-link btn-sm text-decoration-none fw-bold" @onclick="() => ToggleAction(app.Id, ActionType.Invite)">Zmień na: Zaproś</button>
                                                    }
                                                    else
                                                    {
                                                        <button class="btn btn-link btn-sm text-decoration-none fw-bold text-danger" @onclick="() => ToggleAction(app.Id, ActionType.Reject)">Zmień na: Odrzuć</button>
                                                    }
                                                }
                                                else
                                                {
                                                    <span class="text-muted small fst-italic">Zmiana możliwa po @GetUnlockTime(app).ToShortTimeString()</span>
                                                }
                                            </div>
                                        }

                                        @if (activeActionId == app.Id && currentActionType == ActionType.Invite)
                                        {
                                            <div class="action-form fade-in">
                                                <label class="form-label-small text-success">Numer telefonu:</label>
                                                <div class="d-flex gap-2">
                                                    <input @bind="inputPhoneNumber" class="form-control input-phone" placeholder="9 cyfr" maxlength="9" />
                                                    <button class="btn-action btn-invite" @onclick="() => ProcessStatusUpdate(app, ApplicationStatus.Zaproszony)">Wyślij</button>
                                                </div>
                                            </div>
                                        }
                                        @if (activeActionId == app.Id && currentActionType == ActionType.Reject)
                                        {
                                            <div class="action-form fade-in">
                                                <label class="form-label-small text-danger">Powód odrzucenia:</label>
                                                <textarea @bind="inputRejectionReason" class="form-control mb-2 input-phone" rows="2"></textarea>
                                                <div class="text-end">
                                                    <button class="btn-action btn-reject" @onclick="() => ProcessStatusUpdate(app, ApplicationStatus.Odrzucony)">Wyślij</button>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>
            }
        </div>
    }
</div>

@code {
    [Parameter] public int Id { get; set; }

    private JobOffer? jobOffer;
    private List<JobApplication> applications = new();
    private string? currentUserId;
    private string? expandedApplicantId;

    private int? activeActionId;
    private ActionType currentActionType;
    private string inputPhoneNumber = string.Empty;
    private string inputRejectionReason = string.Empty;

    private string? errorMessage;
    private int? errorAppId;

    private enum ActionType { Invite, Reject }

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        currentUserId = authState.User.FindFirstValue(ClaimTypes.NameIdentifier);

        if (string.IsNullOrEmpty(currentUserId))
        {
            NavigationManager.NavigateTo("Account/Login");
            return;
        }

        jobOffer = await JobOfferService.GetByIdAsync(Id);

        if (jobOffer == null || jobOffer.CreatedByUserId != currentUserId)
        {
            NavigationManager.NavigateTo("/my-offers");
            return;
        }

        await LoadApplications();
    }

    private async Task LoadApplications()
    {
        applications = await JobOfferService.GetApplicationsForOfferAsync(Id);
    }

    private bool CanChangeDecision(JobApplication app)
    {
        if (!app.StatusLastUpdated.HasValue) return true;
        return (DateTime.UtcNow - app.StatusLastUpdated.Value).TotalMinutes >= 30;
    }

    private DateTime GetUnlockTime(JobApplication app)
    {
        return (app.StatusLastUpdated ?? DateTime.Now).AddMinutes(30).ToLocalTime();
    }

    private void ToggleAction(int appId, ActionType type)
    {
        activeActionId = appId;
        currentActionType = type;
        inputPhoneNumber = string.Empty;
        inputRejectionReason = string.Empty;
        errorMessage = null;
        errorAppId = null;
    }

    private void CancelAction()
    {
        activeActionId = null;
        errorMessage = null;
        errorAppId = null;
    }

    private async Task ProcessStatusUpdate(JobApplication app, ApplicationStatus newStatus)
    {
        try
        {
            if (newStatus == ApplicationStatus.Zaproszony && (string.IsNullOrWhiteSpace(inputPhoneNumber) || inputPhoneNumber.Length != 9))
            {
                errorMessage = "Podaj poprawny 9-cyfrowy numer telefonu.";
                errorAppId = app.Id;
                return;
            }

            if (newStatus == ApplicationStatus.Odrzucony && string.IsNullOrWhiteSpace(inputRejectionReason))
            {
                errorMessage = "Wymagany powód odrzucenia.";
                errorAppId = app.Id;
                return;
            }

            await JobOfferService.UpdateApplicationStatusAsync(app.Id, newStatus, currentUserId!, inputPhoneNumber, inputRejectionReason);

            app.Status = newStatus;
            app.StatusLastUpdated = DateTime.UtcNow;
            app.EmployerContactPhone = (newStatus == ApplicationStatus.Zaproszony) ? inputPhoneNumber : null;
            app.RejectionReason = (newStatus == ApplicationStatus.Odrzucony) ? inputRejectionReason : null;

            activeActionId = null;
            errorMessage = null;
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
            errorAppId = app.Id;
        }
    }

    private void ToggleDetails(string applicantId)
    {
        if (expandedApplicantId == applicantId) expandedApplicantId = null;
        else expandedApplicantId = applicantId;
        StateHasChanged();
    }

    private string GetExperienceLabel(ExperienceYearsRange experience) => experience switch
    {
        ExperienceYearsRange.Zero => "Brak",
        ExperienceYearsRange.LessThanOne => "< 1 rok",
        ExperienceYearsRange.OneToThree => "1-3 lata",
        ExperienceYearsRange.ThreePlus => "3+ lat",
        _ => "-"
    };

    private string GetInitials(string? name)
    {
        if (string.IsNullOrEmpty(name)) return "?";
        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2) return $"{parts[0][0]}{parts[1][0]}".ToUpper();
        return name.Substring(0, Math.Min(2, name.Length)).ToUpper();
    }
}