@page "/joboffers/edit/{Id:int}"
@using JobSearch.Data
@using JobSearch.Services
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@inject IJobOfferService JobOfferService
@inject NavigationManager NavigationManager
@inject IGeoLocationService GeoLocationService
@rendermode InteractiveServer
@attribute [Authorize(Roles = "Admin,Moderator")]

<PageTitle>Edycja Oferty (Moderator)</PageTitle>

<div class="page-container">
    <div class="page-card p-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 class="card-title m-0">Edycja Oferty <span class="text-muted fs-6">(tryb moderatora)</span></h3>
            <span class="badge bg-secondary">ID: @Id</span>
        </div>
        <hr />

        @if (JobOffer is null)
        {
            <p><em>Ładowanie...</em></p>
        }
        else
        {
            <EditForm method="post" Model="JobOffer" OnValidSubmit="UpdateJobOffer" FormName="edit" Enhance>
                <DataAnnotationsValidator />
                <ValidationSummary class="text-danger" role="alert" />
                <input type="hidden" name="JobOffer.Id" value="@JobOffer.Id" />

                <!-- PANEL MODERATORA -->
                <div class="moderator-panel mb-4">
                    <h5 class="panel-title">
                        <span class="bi bi-shield-check"></span> Panel Moderatora
                    </h5>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="status" class="form-label">Status oferty:</label>
                            <InputSelect id="status" @bind-Value="JobOffer.Status" class="form-select fw-bold">
                                @foreach (var status in Enum.GetValues(typeof(OfferStatus)))
                                {
                                    <option value="@status">@status</option>
                                }
                            </InputSelect>
                            <ValidationMessage For="() => JobOffer.Status" class="text-danger" />
                        </div>
                        <div class="col-md-12">
                            <label for="moderationcomment" class="form-label">
                                Komentarz moderacyjny (widoczny dla właściciela):
                            </label>
                            <InputTextArea id="moderationcomment"
                                           @bind-Value="JobOffer.ModerationComment"
                                           class="form-control"
                                           rows="2"
                                           placeholder="Wpisz powód odrzucenia lub uwagi..." />
                            <ValidationMessage For="() => JobOffer.ModerationComment" class="text-danger" />
                        </div>
                    </div>
                </div>

                <!-- DANE FIRMY -->
                <h5 class="section-title mb-3 text-primary">Dane firmy</h5>
                <div class="row g-3 mb-3">
                    <div class="col-md-6">
                        <label for="nip" class="form-label">NIP Firmy</label>
                        <InputText id="nip" @bind-Value="JobOffer.Nip" class="form-control" ReadOnly="true" />
                    </div>
                    <div class="col-md-6">
                        <label for="companyname" class="form-label">Nazwa firmy</label>
                        <InputText id="companyname" @bind-Value="JobOffer.CompanyName" class="form-control" ReadOnly="true" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Branża</label>
                        <InputSelect class="form-select" @bind-Value="JobOffer.IndustryCategory">
                            <option value="">-- wybierz branżę --</option>
                            @foreach (IndustryCategory category in Enum.GetValues(typeof(IndustryCategory)))
                            {
                                if (category == IndustryCategory.None) continue;
                                <option value="@category">@GetIndustryLabel(category)</option>
                            }
                        </InputSelect>
                    </div>
                </div>

                <hr class="my-4" />

                <!-- SZCZEGÓŁY OFERTY -->
                <h5 class="section-title mb-3 text-primary">Szczegóły oferty</h5>
                <div class="mb-3">
                    <label for="title" class="form-label">Tytuł stanowiska</label>
                    <InputText id="title" @bind-Value="JobOffer.Title" class="form-control" aria-required="true" maxlength="80" />
                    <ValidationMessage For="() => JobOffer.Title" class="text-danger" />
                </div>
                <div class="mb-3">
                    <label for="description" class="form-label">Opis stanowiska</label>
                    <InputTextArea id="description" @bind-Value="JobOffer.Description" class="form-control" rows="5" aria-required="true" maxlength="500" />
                    <ValidationMessage For="() => JobOffer.Description" class="text-danger" />
                </div>

                <div class="row g-3 mb-3">
                    <div class="col-md-6">
                        <label for="location" class="form-label">Lokalizacja</label>
                        <div class="position-relative">
                            <input id="location"
                                   class="form-control @(!string.IsNullOrEmpty(locationValidationMessage) ? "is-invalid" : "")"
                                   value="@JobOffer.Location"
                                   placeholder="np. Warszawa"
                                   maxlength="100"
                                   @oninput="OnOfferLocationInput"
                                   @onfocus="ShowOfferLocationSuggestions"
                                   @onblur="HideOfferLocationSuggestionsDelayed" />

                            @if (showOfferLocationSuggestions && offerLocationSuggestions.Any())
                            {
                                <ul class="list-group position-absolute w-100 shadow-sm suggestions-list"
                                    style="max-height:250px; overflow-y:auto;">
                                    @foreach (var suggestion in offerLocationSuggestions)
                                    {
                                        <li class="list-group-item list-group-item-action"
                                            style="cursor:pointer"
                                            @onmousedown="@(() => SelectOfferLocationSuggestion(suggestion))">
                                            @suggestion
                                        </li>
                                    }
                                </ul>
                            }
                            @if (!string.IsNullOrEmpty(locationValidationMessage))
                            {
                                <div class="invalid-feedback d-block">@locationValidationMessage</div>
                            }
                        </div>
                        <ValidationMessage For="() => JobOffer.Location" class="text-danger" />
                    </div>
                    <div class="col-md-6">
                        <label for="contactinfo" class="form-label">Email kontaktowy</label>
                        <InputText id="contactinfo" @bind-Value="JobOffer.ContactInfo" class="form-control" aria-required="true" maxlength="250" />
                        <ValidationMessage For="() => JobOffer.ContactInfo" class="text-danger" />
                    </div>
                </div>

                <div class="row g-3 mb-3">
                    <div class="col-md-4">
                        <label for="dateposted" class="form-label">Data dodania</label>
                        <InputDate id="dateposted" @bind-Value="JobOffer.DatePosted" class="form-control" ReadOnly="true" />
                        <ValidationMessage For="() => JobOffer.DatePosted" class="text-danger" />
                    </div>
                    <div class="col-md-4">
                        <label for="applicationdeadline" class="form-label">Ważna do</label>
                        <InputDate id="applicationdeadline" @bind-Value="JobOffer.ApplicationDeadline" class="form-control" min="@today" />
                        <ValidationMessage For="() => JobOffer.ApplicationDeadline" class="text-danger" />
                    </div>
                </div>

                <div class="row g-3 mb-3">
                    <div class="col-md-6">
                        <label for="empltype" class="form-label">Rodzaj zatrudnienia</label>
                        <InputSelect id="empltype" @bind-Value="JobOffer.EmplType" class="form-select" aria-required="true">
                            @foreach (var value in Enum.GetValues(typeof(EmploymentType)))
                            {
                                <option value="@value">@value</option>
                            }
                        </InputSelect>
                    </div>
                    <div class="col-md-6">
                        <label for="jobtype" class="form-label">Tryb pracy</label>
                        <InputSelect id="jobtype" @bind-Value="JobOffer.JobType" class="form-select" aria-required="true">
                            @foreach (var value in Enum.GetValues(typeof(JobType)))
                            {
                                <option value="@value">@value</option>
                            }
                        </InputSelect>
                    </div>
                </div>

                <div class="row g-3 mb-3">
                    <div class="col-md-6">
                        <label for="salarymin" class="form-label">Wynagrodzenie (min)</label>
                        <InputNumber id="salarymin" @bind-Value="JobOffer.SalaryMin" class="form-control" />
                        <ValidationMessage For="() => JobOffer.SalaryMin" class="text-danger" />
                    </div>
                    <div class="col-md-6">
                        <label for="salarymax" class="form-label">Wynagrodzenie (max)</label>
                        <InputNumber id="salarymax" @bind-Value="JobOffer.SalaryMax" class="form-control" />
                        <ValidationMessage For="() => JobOffer.SalaryMax" class="text-danger" />
                    </div>
                </div>

                <hr class="my-4" />

                <!-- WYMAGANIA + BENEFITY -->
                <h5 class="section-title mb-3 text-primary">Wymagania i Benefity</h5>
                <div class="mb-3">
                    <label for="requirements" class="form-label">Wymagania</label>
                    <InputTextArea id="requirements" @bind-Value="JobOffer.Requirements" class="form-control" rows="5" aria-required="true" maxlength="500" />
                    <ValidationMessage For="() => JobOffer.Requirements" class="text-danger" />
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold d-block text-center">Dodatkowe opcje (Tagi):</label>

                    <div class="options-container">
                        <label class="custom-check @(JobOffer.RequiresExperience ? "active" : "")">
                            <input type="checkbox" @bind="JobOffer.RequiresExperience" /> Doświadczenie
                        </label>
                        <label class="custom-check @(JobOffer.IsOnlineRecruitment ? "active" : "")">
                            <input type="checkbox" @bind="JobOffer.IsOnlineRecruitment" /> Rekrutacja Online
                        </label>
                        <label class="custom-check @(JobOffer.RequiresSanitaryBook ? "active" : "")">
                            <input type="checkbox" @bind="JobOffer.RequiresSanitaryBook" /> Sanepid
                        </label>
                        <label class="custom-check @(JobOffer.RequiresStudentStatus ? "active" : "")">
                            <input type="checkbox" @bind="JobOffer.RequiresStudentStatus" /> Student
                        </label>
                        <label class="custom-check @(JobOffer.RequiresDisabilityCertificate ? "active" : "")">
                            <input type="checkbox" @bind="JobOffer.RequiresDisabilityCertificate" /> Orzeczenie
                        </label>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="benefits" class="form-label">Benefity</label>
                    <InputText id="benefits" @bind-Value="JobOffer.Benefits" class="form-control" maxlength="200" />
                    <ValidationMessage For="() => JobOffer.Benefits" class="text-danger" />
                </div>

                <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                    <a href="/joboffers" class="btn btn-outline-secondary me-md-2">Anuluj</a>
                    <button type="submit" class="btn btn-primary">Zapisz zmiany</button>
                </div>
            </EditForm>
        }
    </div>
</div>

@code {
    [Parameter] public int Id { get; set; }

    [SupplyParameterFromForm]
    private JobOffer? JobOffer { get; set; }

    private string today = DateTime.Now.ToString("yyyy-MM-dd");

    private List<string> offerLocationSuggestions = new();
    private bool showOfferLocationSuggestions = false;
    private string? locationValidationMessage;

    private string GetIndustryLabel(IndustryCategory category) => category switch
    {
        IndustryCategory.Sprzedaz => "Sprzedaż",
        IndustryCategory.Marketing => "Marketing",
        IndustryCategory.IT => "IT",
        IndustryCategory.Finanse => "Finanse",
        _ => category.ToString()
    };

    protected override async Task OnParametersSetAsync()
    {
        JobOffer ??= await JobOfferService.GetByIdAsync(Id);
        if (JobOffer is null)
            NavigationManager.NavigateTo("notfound");
    }

    private async Task UpdateJobOffer()
    {
        if (JobOffer is null) return;

        if (string.IsNullOrWhiteSpace(JobOffer.Location))
        {
            locationValidationMessage = "Lokalizacja jest wymagana.";
            return;
        }

        var suggestions = await GeoLocationService.SuggestLocationsAsync(JobOffer.Location, 10);
        var isValidLocation = suggestions.Any(s => s.DisplayName.Equals(JobOffer.Location, StringComparison.OrdinalIgnoreCase));

        if (!isValidLocation)
        {
            locationValidationMessage = "Wybierz poprawną miejscowość z listy podpowiedzi.";
            return;
        }

        if (JobOffer.Status != OfferStatus.Odrzucona)
        {
            JobOffer.ModerationComment = null;
        }

        await JobOfferService.UpdateAsync(JobOffer);
        NavigationManager.NavigateTo("/joboffers");
    }

    private async Task OnOfferLocationInput(ChangeEventArgs e)
    {
        var text = e.Value?.ToString() ?? string.Empty;
        if (JobOffer is not null) JobOffer.Location = text;
        locationValidationMessage = null;

        if (!string.IsNullOrWhiteSpace(text) && text.Length >= 2)
        {
            var suggestions = await GeoLocationService.SuggestLocationsAsync(text, 10);
            offerLocationSuggestions = suggestions.Select(s => s.DisplayName).Distinct().ToList();
            showOfferLocationSuggestions = offerLocationSuggestions.Any();
        }
        else
        {
            offerLocationSuggestions.Clear();
            showOfferLocationSuggestions = false;
        }
    }

    private void ShowOfferLocationSuggestions()
    {
        if (offerLocationSuggestions.Any()) showOfferLocationSuggestions = true;
    }

    private async Task HideOfferLocationSuggestionsDelayed()
    {
        await Task.Delay(200);
        showOfferLocationSuggestions = false;
        StateHasChanged();
    }

    private void SelectOfferLocationSuggestion(string suggestion)
    {
        if (JobOffer is not null) JobOffer.Location = suggestion;
        showOfferLocationSuggestions = false;
        locationValidationMessage = null;
    }
}
