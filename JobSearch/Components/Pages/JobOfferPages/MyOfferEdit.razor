@page "/my-offers/edit/{Id:int}"
@using JobSearch.Data
@using JobSearch.Services
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using System.Security.Claims

@inject IJobOfferService JobOfferService
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IGeoLocationService GeoLocationService

@rendermode InteractiveServer
@attribute [Authorize]

<PageTitle>Edytuj Ofertę</PageTitle>

<div class="page-container">
    <div class="edit-card animate-fade-up">

        <div class="card-header-block">
            <h1 class="card-title">Edycja Oferty</h1>
            <p class="card-subtitle">Zaktualizuj informacje o stanowisku, zmiany spowodują ponowną weryfikację.</p>
        </div>

        @if (JobOffer == null)
        {
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status"></div>
            </div>
        }
        else
        {
            <EditForm method="post" Model="JobOffer" OnValidSubmit="UpdateJobOffer" FormName="edit" Enhance>
                <DataAnnotationsValidator />
                <input type="hidden" name="JobOffer.Id" value="@JobOffer.Id" />

                <div class="section-label">1. Dane Firmy</div>
                <div class="row g-4">
                    <div class="col-md-4">
                        <label class="form-label">NIP (Nieedytowalny)</label>
                        <InputText id="nip" @bind-Value="JobOffer.Nip" class="form-control" ReadOnly="true" />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Nazwa Firmy</label>
                        <InputText id="companyname" @bind-Value="JobOffer.CompanyName" class="form-control" ReadOnly="true" />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Branża</label>
                        <InputSelect class="form-select" @bind-Value="JobOffer.IndustryCategory">
                            <option value="">-- Wybierz --</option>
                            @foreach (IndustryCategory category in Enum.GetValues(typeof(IndustryCategory)))
                            {
                                if (category == IndustryCategory.None) continue;
                                <option value="@category">@GetIndustryLabel(category)</option>
                            }
                        </InputSelect>
                        <ValidationMessage For="() => JobOffer.IndustryCategory" class="text-danger small" />
                    </div>
                </div>

                <div class="section-label">2. Szczegóły Oferty</div>
                <div class="row g-4">
                    <div class="col-md-4">
                        <label class="form-label">Tytuł Stanowiska</label>
                        <InputText id="title" @bind-Value="JobOffer.Title" class="form-control fw-bold" aria-required="true" maxlength="80" />
                        <ValidationMessage For="() => JobOffer.Title" class="text-danger small" />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Lokalizacja</label>
                        <div class="position-relative">
                            <input class="form-control @(!string.IsNullOrEmpty(locationValidationMessage) ? "is-invalid" : "")"
                                   value="@JobOffer.Location"
                                   placeholder="Miasto..."
                                   @oninput="OnOfferLocationInput"
                                   @onfocus="ShowOfferLocationSuggestions"
                                   @onblur="HideOfferLocationSuggestionsDelayed" />

                            @if (showOfferLocationSuggestions && offerLocationSuggestions.Any())
                            {
                                <ul class="suggestions-list">
                                    @foreach (var suggestion in offerLocationSuggestions)
                                    {
                                        <li @onmousedown="@(() => SelectOfferLocationSuggestion(suggestion))">@suggestion</li>
                                    }
                                </ul>
                            }
                            @if (!string.IsNullOrEmpty(locationValidationMessage))
                            {
                                <div class="text-danger small">@locationValidationMessage</div>
                            }
                        </div>
                        <ValidationMessage For="() => JobOffer.Location" class="text-danger small" />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Email kontaktowy</label>
                        <InputText id="contactinfo" @bind-Value="JobOffer.ContactInfo" class="form-control" aria-required="true" maxlength="250" />
                        <ValidationMessage For="() => JobOffer.ContactInfo" class="text-danger small" />
                    </div>
                </div>

                <div class="row g-4 mt-2">
                    <div class="col-md-6">
                        <label class="form-label">Opis Stanowiska</label>
                        <InputTextArea id="description" @bind-Value="JobOffer.Description" class="form-control" rows="6" aria-required="true" maxlength="500" />
                        <ValidationMessage For="() => JobOffer.Description" class="text-danger small" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Wymagania Szczegółowe</label>
                        <InputTextArea id="requirements" @bind-Value="JobOffer.Requirements" class="form-control" rows="6" aria-required="true" maxlength="500" />
                        <ValidationMessage For="() => JobOffer.Requirements" class="text-danger small" />
                    </div>
                </div>

                <div class="section-label">3. Warunki Zatrudnienia</div>
                <div class="row g-4">
                    <div class="col-md-3">
                        <label class="form-label">Wymiar</label>
                        <InputSelect id="empltype" @bind-Value="JobOffer.EmplType" class="form-control" aria-required="true">
                            @foreach (var type in Enum.GetValues(typeof(EmploymentType)).Cast<EmploymentType>())
                            {
                                <option value="@type">@type</option>
                            }
                        </InputSelect>
                        <ValidationMessage For="() => JobOffer.EmplType" class="text-danger small" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Tryb</label>
                        <InputSelect id="jobtype" @bind-Value="JobOffer.JobType" class="form-control" aria-required="true">
                            @foreach (var type in Enum.GetValues(typeof(JobType)).Cast<JobType>())
                            {
                                <option value="@type">@type</option>
                            }
                        </InputSelect>
                        <ValidationMessage For="() => JobOffer.JobType" class="text-danger small" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Płaca (Min)</label>
                        <div class="input-group">
                            <InputNumber id="salarymin" @bind-Value="JobOffer.SalaryMin" class="form-control" />
                            <span class="input-group-text">PLN</span>
                        </div>
                        <ValidationMessage For="() => JobOffer.SalaryMin" class="text-danger small" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Płaca (Max)</label>
                        <div class="input-group">
                            <InputNumber id="salarymax" @bind-Value="JobOffer.SalaryMax" class="form-control" />
                            <span class="input-group-text">PLN</span>
                        </div>
                        <ValidationMessage For="() => JobOffer.SalaryMax" class="text-danger small" />
                    </div>
                </div>

                <div class="section-label">4. Benefity i Opcje</div>

                <div class="row g-4 mb-4">
                    <div class="col-md-8">
                        <label class="form-label">Benefity</label>
                        <InputText id="benefits" @bind-Value="JobOffer.Benefits" class="form-control" maxlength="200" />
                        <ValidationMessage For="() => JobOffer.Benefits" class="text-danger small" />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Ważna do</label>
                        <InputDate id="applicationdeadline" @bind-Value="JobOffer.ApplicationDeadline" class="form-control" min="@today" />
                        <ValidationMessage For="() => JobOffer.ApplicationDeadline" class="text-danger small" />
                    </div>
                </div>

                <label class="form-label fw-bold mb-3 d-block text-center">Dodatkowe Opcje:</label>
                <div class="options-container mb-5">
                    <label class="custom-check @(JobOffer.RequiresExperience ? "active" : "")">
                        <InputCheckbox @bind-Value="JobOffer.RequiresExperience" /> Doświadczenie
                    </label>
                    <label class="custom-check @(JobOffer.IsOnlineRecruitment ? "active" : "")">
                        <InputCheckbox @bind-Value="JobOffer.IsOnlineRecruitment" /> Rekrutacja Online
                    </label>
                    <label class="custom-check @(JobOffer.RequiresSanitaryBook ? "active" : "")">
                        <InputCheckbox @bind-Value="JobOffer.RequiresSanitaryBook" /> Sanepid
                    </label>
                    <label class="custom-check @(JobOffer.RequiresStudentStatus ? "active" : "")">
                        <InputCheckbox @bind-Value="JobOffer.RequiresStudentStatus" /> Student
                    </label>
                    <label class="custom-check @(JobOffer.RequiresDisabilityCertificate ? "active" : "")">
                        <InputCheckbox @bind-Value="JobOffer.RequiresDisabilityCertificate" /> Orzeczenie
                    </label>
                </div>

                @if (!string.IsNullOrEmpty(serverErrorMessage))
                {
                    <div class="alert alert-danger mt-4 shadow-sm">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i> <strong>Błąd zapisu:</strong> @serverErrorMessage
                    </div>
                }

                <div class="d-flex justify-content-end align-items-center gap-3 pt-3 border-top border-light">
                    <a href="/my-offers" class="btn-cancel">Anuluj</a>
                    <button type="submit" class="btn-submit">Zapisz Zmiany</button>
                </div>
            </EditForm>
        }
    </div>
</div>

@code {
    [Parameter]
    public int Id { get; set; }

    [SupplyParameterFromForm]
    private JobOffer? JobOffer { get; set; }

    private string? currentUserId;
    private string today = DateTime.Now.ToString("yyyy-MM-dd");
    private string? serverErrorMessage;

    private List<string> offerLocationSuggestions = new();
    private bool showOfferLocationSuggestions = false;
    private string? locationValidationMessage;

    private string GetIndustryLabel(IndustryCategory category) => category.ToString();

    protected override async Task OnParametersSetAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        currentUserId = authState.User.FindFirstValue(ClaimTypes.NameIdentifier);

        if (string.IsNullOrEmpty(currentUserId))
        {
            NavigationManager.NavigateTo("Account/Login");
            return;
        }

        JobOffer ??= await JobOfferService.GetByIdAsync(Id);

        if (JobOffer is null || JobOffer.CreatedByUserId != currentUserId)
        {
            NavigationManager.NavigateTo("/my-offers");
            return;
        }
    }

    private async Task UpdateJobOffer()
    {
        if (JobOffer is null) return;

        // Walidacja lokalizacji
        if (string.IsNullOrWhiteSpace(JobOffer.Location))
        {
            locationValidationMessage = "Lokalizacja jest wymagana.";
            return;
        }
        var suggestions = await GeoLocationService.SuggestLocationsAsync(JobOffer.Location, 10);
        var isValidLocation = suggestions.Any(s => s.DisplayName.Equals(JobOffer.Location, StringComparison.OrdinalIgnoreCase));

        if (!isValidLocation)
        {
            locationValidationMessage = "Wybierz poprawną miejscowość z listy podpowiedzi.";
            return;
        }

        try
        {
            if (JobOffer.Status != OfferStatus.Odrzucona)
            {
                JobOffer.ModerationComment = null;
            }

            await JobOfferService.UpdateAsync(JobOffer);
            NavigationManager.NavigateTo("/my-offers");
        }
        catch (Exception ex)
        {
            serverErrorMessage = ex.InnerException?.Message ?? ex.Message;
        }
    }

    // --- AUTOCOMPLETE LOKALIZACJI ---
    private async Task OnOfferLocationInput(ChangeEventArgs e)
    {
        var text = e.Value?.ToString() ?? string.Empty;
        if (JobOffer is not null) JobOffer.Location = text;
        locationValidationMessage = null;

        if (!string.IsNullOrWhiteSpace(text) && text.Length >= 2)
        {
            var suggestions = await GeoLocationService.SuggestLocationsAsync(text, 10);
            offerLocationSuggestions = suggestions.Select(s => s.DisplayName).Distinct().ToList();
            showOfferLocationSuggestions = offerLocationSuggestions.Any();
        }
        else
        {
            offerLocationSuggestions.Clear();
            showOfferLocationSuggestions = false;
        }
    }

    private void ShowOfferLocationSuggestions()
    {
        if (offerLocationSuggestions.Any()) showOfferLocationSuggestions = true;
    }

    private async Task HideOfferLocationSuggestionsDelayed()
    {
        await Task.Delay(200);
        showOfferLocationSuggestions = false;
        StateHasChanged();
    }

    private void SelectOfferLocationSuggestion(string suggestion)
    {
        if (JobOffer is not null) JobOffer.Location = suggestion;
        showOfferLocationSuggestions = false;
        locationValidationMessage = null;
    }
}