@page "/admin/users/new"
@using JobSearch.Data
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using System.ComponentModel.DataAnnotations

@rendermode InteractiveServer
@attribute [Authorize(Roles = "Admin")]
@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager Nav

<div class="text-center">
    <h1>Nowy użytkownik</h1>
</div>

@if (!string.IsNullOrWhiteSpace(Message))
{
    <div class="alert alert-danger">@Message</div>
}

<div class="row justify-content-center">
    <div class="col-md-6 col-lg-4">
        <EditForm Model="@model" OnValidSubmit="Save" class="mb-3" novalidate>
            <DataAnnotationsValidator />
            @* USUNIĘTE: ValidationSummary, żeby nie dublować błędów *@
            @* <ValidationSummary class="text-danger" /> *@

            <div class="mb-3">
                <label class="form-label" for="emailInput">Email</label>
                <input id="emailInput" @bind="model.Email" class="form-control" placeholder="name@example.com" />
                <ValidationMessage For="() => model.Email" class="text-danger" />
            </div>

            <div class="mb-3">
                <label class="form-label" for="displayNameInput">Nazwa</label>
                <input id="displayNameInput" @bind="model.DisplayName" class="form-control" placeholder="Nazwa" />
                <ValidationMessage For="() => model.DisplayName" class="text-danger" />
            </div>

            <div class="mb-3">
                <label class="form-label">Typ konta:</label>
                <select @bind="model.AccountType" class="form-select">
                    <option value="">Wybierz typ konta</option>
                    <option value="Individual">Osoba prywatna</option>
                    <option value="Company">Firma</option>
                </select>
                <ValidationMessage For="() => model.AccountType" class="text-danger" />
            </div>

            <div class="mb-3">
                <label class="form-label" for="passwordInput">Hasło</label>
                <input id="passwordInput" @bind="model.Password" type="password" class="form-control" placeholder="Hasło" />
                <ValidationMessage For="() => model.Password" class="text-danger" />
            </div>

            <div class="mb-3">
                <label class="form-label">Rola:</label>
                <select @bind="model.Role" class="form-select">
                    <option value="">Wybierz rolę</option>
                    <option value="User">User</option>
                    <option value="Moderator">Moderator</option>
                    <option value="Admin">Admin</option>
                </select>
                <ValidationMessage For="() => model.Role" class="text-danger" />
            </div>

            <div class="d-grid gap-2">
                <button type="submit" class="w-100 btn btn-lg btn-primary">Zapisz</button>
                <button type="button" class="btn btn-secondary" @onclick="Back">Anuluj</button>
            </div>
        </EditForm>
    </div>
</div>

@code {
    private IEnumerable<IdentityError>? identityErrors;

    private CreateUserDto model = new();
    private string? Message => identityErrors is null ? null : $"Błąd tworzenia użytkownika: {string.Join(", ", identityErrors.Select(error => error.Description))}";

    private async Task Save()
    {
        var user = new ApplicationUser
        {
            UserName = model.Email,
            Email = model.Email,
            DisplayName = model.DisplayName,
            AccountType = model.AccountType,
            EmailConfirmed = true
        };

        var res = await UserManager.CreateAsync(user, model.Password);

        if (!string.IsNullOrWhiteSpace(model.AccountType))
        {
            user.AccountType = model.AccountType;
        }

        if (!res.Succeeded)
        {
            identityErrors = res.Errors;
            return;
        }

        if (!string.IsNullOrWhiteSpace(model.Role))
        {
            await UserManager.AddToRoleAsync(user, model.Role);
        }

        Back();
    }

    private void Back() => Nav.NavigateTo("/admin/users");

    private sealed class CreateUserDto
    {
        [Required(ErrorMessage = "Adres email jest wymagany.")]
        [EmailAddress(ErrorMessage = "Nieprawidłowy format adresu email.")]
        public string Email { get; set; } = "";

        [Required(ErrorMessage = "Hasło jest wymagane.")]
        [MinLength(8, ErrorMessage = "Hasło musi mieć co najmniej 8 znaków.")]
        public string Password { get; set; } = "";

        public string? DisplayName { get; set; }
        public string? AccountType { get; set; }
        public string? Role { get; set; }
    }
}
