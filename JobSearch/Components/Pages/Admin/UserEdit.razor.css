@page

"/admin/users/{id}"

@using JobSearch.Data
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using System.ComponentModel.DataAnnotations

@rendermode InteractiveServer
@attribute [Authorize(Roles = "Admin")]
@inject UserManager<ApplicationUser > UserManager
@inject RoleManager<IdentityRole > RoleManager
@inject NavigationManager Nav

<div class="text-center" >
<h1 > Edycja użytkownika</h1 >
</div >

@if (user is null) {
    <p>Ładowanie...</p>
}

else {
    <div class="row justify-content-center"> <div class="col-md-6 col-lg-4"> <EditForm Model="@model" OnValidSubmit="Save"> <DataAnnotationsValidator /> <ValidationSummary class="text-danger" /> <div class="mb-3"> <label class="form-label">Email</label> <input class="form-control" value="@user.Email" disabled /> </div> <div class="mb-3"> <label class="form-label">Nazwa</label> <input @bind="model.DisplayName" class="form-control" placeholder="Nazwa" /> <ValidationMessage For="() => model.DisplayName" class="text-danger" /> </div> <div class="mb-3"> <label class="form-label">Typ konta:</label> <select @bind="model.AccountType" class="form-select"> <option value="">Wybierz typ konta</option> <option value="Individual">Osoba prywatna</option> <option value="Company">Firma</option> </select> <ValidationMessage For="() => model.AccountType" class="text-danger" /> </div> <div class="mb-3"> <label class="form-label">Zablokuj do:</label> <input @bind="model.LockoutEnd" class="form-control" type="date" /> <ValidationMessage For="() => model.LockoutEnd" class="text-danger" /> </div> <div class="mb-3"> <label class="form-label">Rola:</label> <select @bind="model.Role" class="form-select"> <option value="">Wybierz rolę</option> <option value="User">User</option> <option value="Moderator">Moderator</option> <option value="Admin">Admin</option> </select> <ValidationMessage For="() => model.Role" class="text-danger" /> </div> <div class="mb-3"> <h5 class="text-light">Reset hasła</h5> <div class="input-group"> <input @bind="newPassword" type="password" class="form-control" placeholder="Nowe hasło" /> <button type="button" class="btn btn-secondary" @onclick="ResetPassword">Ustaw hasło</button> </div> </div> <div class="d-grid gap-2"> <button type="submit" class="w-100 btn btn-lg btn-primary">Zapisz</button> <button type="button" class="btn btn-secondary" @onclick="Back">Wróć</button> </div> </EditForm> </div> </div>
}

@code {
    [Parameter] public string id {
        get;
        set;
    }

    = "";
    private ApplicationUser? user;
    private EditUserDto model = new();
    private HashSet<string> selectedRoles = new();
    private List<string> allRoles = new();
    private string newPassword = "";

    protected override async Task OnParametersSetAsync() {
        user = await UserManager.FindByIdAsync(id);
        if (user is null) return;
        model .DisplayName = user.DisplayName;
        model .AccountType = user.AccountType;
        model .LockoutEnd = user.LockoutEnd?.UtcDateTime;
        var roles = await UserManager.GetRolesAsync(user);
        model .Role = roles.FirstOrDefault();
    }

    private async Task Save() {
        if (user is null) return;
        user .DisplayName = model.DisplayName;
        user .AccountType = model.AccountType;
        user .LockoutEnd = model.LockoutEnd.HasValue ? new DateTimeOffset(DateTime.SpecifyKind(model.LockoutEnd.Value, DateTimeKind.Utc)) : null;
        await UserManager.UpdateAsync(user);
        var currentRoles = await UserManager.GetRolesAsync(user);
        if (currentRoles.Any())

{
    await UserManager.RemoveFromRolesAsync(user, currentRoles);
}

if (!string.IsNullOrWhiteSpace(model.Role)) {
    if (!await RoleManager.RoleExistsAsync(model.Role))

{
    await RoleManager.CreateAsync(new IdentityRole(model.Role));
}

await UserManager.AddToRoleAsync(user, model.Role);
}
Back();
}

private void ToggleRole(string role, bool isChecked) {
    if (isChecked) selectedRoles.Add(role);
    else selectedRoles.Remove(role);
    StateHasChanged();
}

private async Task ResetPassword() {
    if (user is null || string.IsNullOrWhiteSpace(newPassword)) return;
    var token = await UserManager.GeneratePasswordResetTokenAsync(user);
    await UserManager.ResetPasswordAsync(user, token, newPassword);
    newPassword = "";
}

private void Back() = > Nav.NavigateTo("/admin/users");

private sealed class EditUserDto {
    [Required(ErrorMessage = "Wymagana nazwa.")] public string? DisplayName

{
    get;
    set;
}

public string? AccountType {
    get;
    set;
}

public DateTime? LockoutEnd {
    get;
    set;
}

public string? Role {
    get;
    set;
}

}
}

/* === 1. KONTENER GŁÓWNY === */
:host {
    display: block;
    color: #ffffff;
    font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    /* Dodajemy minimalną wysokość i centrowanie pionowe dla lepszego wyglądu */
    min-height: calc(100vh - 60px);
    display: flex;
    flex-direction: column;
    align-items: center;
    padding-top: 2rem;
    padding-bottom: 2rem;
}

/* Wyśrodkowanie nagłówka */
h1 {
    font-weight: 800;
    font-size: 2.5rem;
    color: #ffffff;
    text-shadow: 0 4px 10px rgba(0, 0, 0, 0.35);
    margin-bottom: 2rem;
    text-align: center;
    width: 100%;
}

/* Kontener dla formularza (karta edycji) */
.col-md-6 {
    /* Ustawienia tła i cieni */
    background: rgba(15, 23, 42, 0.9) !important;
    border-radius: 24px;
    padding: 2rem;
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.6);
    border: 1px solid rgba(148, 163, 184, 0.25);
    position: relative;
    overflow: hidden;
    padding-top: 2.5rem;
}

    /* NOWY: Pseudo-element dla paska gradientowego na górze kontenera */
    .col-md-6::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #2563eb 0%, #a78bfa 50%, #10b981 100%);
        z-index: 3;
        border-top-left-radius: 24px;
        border-top-right-radius: 24px;
    }

/* Nagłówki (Reset hasła) */
.col-md-4 h5 {
    color: #60a5fa;
    font-weight: 700;
    padding-bottom: 5px;
    border-bottom: 1px solid #475569;
    margin-bottom: 1rem;
}


/* === UJEDNOLICONE POLA FORMULARZA (form-control, form-select) === */

/* Wymuszamy ciemne tło i biały tekst DLA WSZYSTKICH INPUTÓW/SELECTÓW */
.form-control,
.form-select,
.input-group input {
    background-color: rgba(30, 41, 59, 0.95) !important;
    border: 1px solid #475569 !important;
    color: #ffffff !important; /* BIAŁY TEKST */
    box-shadow: none !important;
}

    /* Wymuszamy ciemne tło w trybie tylko do odczytu (Email) */
    .form-control:disabled,
    .form-control[readonly] {
        background-color: #111827 !important;
        color: #94a3b8 !important; /* Szary tekst dla pól zablokowanych */
    }

/* Style dla etykiet i tekstu */
.form-label,
.form-floating label {
    color: #e5e7eb !important;
}

/* Focus inputów */
.form-control:focus,
.form-select:focus {
    border-color: #2563eb !important;
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.35) !important;
}

/* --- ZMIANA KOLORU IKONKI KALENDARZA NA BIAŁY --- */
input[type="date"]::-webkit-calendar-picker-indicator {
    filter: invert(1);
    cursor: pointer;
    opacity: 0.8;
}

/* Reset hasła - przycisk dodatkowy */
.input-group .btn-secondary {
    background-color: #475569;
    border-color: #475569;
    color: #ffffff;
    border-radius: 0 12px 12px 0;
    font-weight: 600;
}

/* --- PRZYCISKI GŁÓWNE --- */
.btn-primary {
    background-color: #2563eb;
    border-color: #2563eb;
    transition: all 0.2s;
}

.btn-secondary {
    background-color: #64748b;
    border-color: #64748b;
    color: #ffffff;
    transition: all 0.2s;
}
