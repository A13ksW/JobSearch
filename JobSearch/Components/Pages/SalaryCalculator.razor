@page "/salary-calculator"
@rendermode InteractiveServer
@using System.ComponentModel.DataAnnotations

<PageTitle>Kalkulator Wynagrodzeń Pro</PageTitle>

<div class="pracuj-wrapper">
    <div class="calculator-card">

        <h2 class="calc-title">Oblicz wynagrodzenie</h2>

        <div class="top-bar">
            <div class="amount-container">
                <label class="small-label">Podaj wynagrodzenie</label>
                <div class="input-group custom-input-group">
                    <InputNumber @bind-Value="Input.Amount" class="form-control amount-input" placeholder="0,00" @oninput="OnAmountChange" />
                    <span class="input-group-text currency-text">zł</span>
                </div>
            </div>

            <div class="toggle-container">
                <div class="radio-option" @onclick='() => UpdateAmountType(AmountType.Gross)'>
                    <div class="custom-radio @(Input.AmountType == AmountType.Gross ? "checked" : "")">
                        <div class="dot"></div>
                    </div>
                    <span>brutto</span>
                </div>
                <div class="radio-option" @onclick='() => UpdateAmountType(AmountType.Net)'>
                    <div class="custom-radio @(Input.AmountType == AmountType.Net ? "checked" : "")">
                        <div class="dot"></div>
                    </div>
                    <span>netto (na rękę)</span>
                </div>
            </div>

            <button class="btn-oblicz-top" @onclick="Calculate">Oblicz</button>
        </div>

        <div class="tabs-row">
            <button class="tab-btn @(Input.ContractType == ContractType.UoP ? "active" : "")" @onclick="() => SetContract(ContractType.UoP)">
                umowa o pracę
            </button>
            <button class="tab-btn @(Input.ContractType == ContractType.Zlecenie ? "active" : "")" @onclick="() => SetContract(ContractType.Zlecenie)">
                umowa zlecenie
            </button>
            <button class="tab-btn @(Input.ContractType == ContractType.Dzielo ? "active" : "")" @onclick="() => SetContract(ContractType.Dzielo)">
                umowa o dzieło
            </button>
            <button class="tab-btn @(Input.ContractType == ContractType.B2B ? "active" : "")" @onclick="() => SetContract(ContractType.B2B)">
                kontrakt B2B
            </button>
        </div>

        <div class="form-container">

            <div class="form-group-row">
                <div class="label-col">
                    <span class="main-label">Stałe wynagrodzenie<span class="req">*</span></span>
                    <span class="sub-label">nie różni się w poszczególnych miesiącach</span>
                </div>
                <div class="input-col">
                    <div class="yes-no-toggle">
                        <div class="radio-option" @onclick="() => Input.IsFixedSalary = true">
                            <div class="custom-radio @(Input.IsFixedSalary ? "checked" : "")"><div class="dot"></div></div>
                            <span>tak</span>
                        </div>
                        <div class="radio-option" @onclick="() => Input.IsFixedSalary = false">
                            <div class="custom-radio @(!Input.IsFixedSalary ? "checked" : "")"><div class="dot"></div></div>
                            <span>nie</span>
                        </div>
                    </div>
                </div>
            </div>

            <hr class="divider" />

            @if (Input.ContractType == ContractType.UoP)
            {
                <div class="form-group-row">
                    <div class="label-col">
                        <span class="main-label">Wspólne rozliczanie z małżonkiem<span class="req">*</span></span>
                    </div>
                    <div class="input-col">
                        <div class="yes-no-toggle">
                            <div class="radio-option" @onclick="() => { Input.UoP_JointTaxation = true; Calculate(); }">
                                <div class="custom-radio @(Input.UoP_JointTaxation ? "checked" : "")"><div class="dot"></div></div>
                                <span>tak</span>
                            </div>
                            <div class="radio-option" @onclick="() => { Input.UoP_JointTaxation = false; Calculate(); }">
                                <div class="custom-radio @(!Input.UoP_JointTaxation ? "checked" : "")"><div class="dot"></div></div>
                                <span>nie</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group-row">
                    <div class="label-col">
                        <span class="main-label">Ubezpieczenie wypadkowe<span class="req">*</span></span>
                    </div>
                    <div class="input-col">
                        <div class="input-group" style="width: 120px; margin-left: auto;">
                            <input type="number" @bind="Input.AccidentRate" @bind:event="oninput" @onkeyup="Calculate" class="form-control text-end" />
                            <span class="input-group-text">%</span>
                        </div>
                    </div>
                </div>

                <div class="form-group-row">
                    <div class="label-col">
                        <span class="main-label">Uczestnictwo w PPK</span>
                    </div>
                    <div class="input-col">
                        <div class="yes-no-toggle">
                            <div class="radio-option" @onclick="() => { Input.UsePPK = true; Calculate(); }">
                                <div class="custom-radio @(Input.UsePPK ? "checked" : "")"><div class="dot"></div></div>
                                <span>tak</span>
                            </div>
                            <div class="radio-option" @onclick="() => { Input.UsePPK = false; Calculate(); }">
                                <div class="custom-radio @(!Input.UsePPK ? "checked" : "")"><div class="dot"></div></div>
                                <span>nie</span>
                            </div>
                        </div>
                    </div>
                </div>
            }

            @if (Input.ContractType == ContractType.Zlecenie)
            {
                <div class="form-group-row">
                    <div class="label-col">
                        <span class="main-label">Wybierz opcję<span class="req">*</span></span>
                    </div>
                    <div class="input-col">
                        <select class="form-select styled-select" @bind="Input.Zlecenie_Status" @bind:after="Calculate">
                            <option value="@ZlecenieStatus.Standard">ZUS płacę u tego pracodawcy</option>
                            <option value="@ZlecenieStatus.EmployedElsewhere">ZUS płacę u innego pracodawcy</option>
                            <option value="@ZlecenieStatus.StudentUnder26">Jestem studentem do 26 roku życia</option>
                        </select>
                    </div>
                </div>

                @if (Input.Zlecenie_Status != ZlecenieStatus.StudentUnder26)
                {
                    <div class="form-group-row">
                        <div class="label-col">
                            <span class="main-label">Dobrowolne ubezpieczenie chorobowe<span class="req">*</span></span>
                        </div>
                        <div class="input-col">
                            <div class="yes-no-toggle">
                                <div class="radio-option" @onclick="() => { Input.Zlecenie_Sickness = true; Calculate(); }">
                                    <div class="custom-radio @(Input.Zlecenie_Sickness ? "checked" : "")"><div class="dot"></div></div>
                                    <span>tak</span>
                                </div>
                                <div class="radio-option" @onclick="() => { Input.Zlecenie_Sickness = false; Calculate(); }">
                                    <div class="custom-radio @(!Input.Zlecenie_Sickness ? "checked" : "")"><div class="dot"></div></div>
                                    <span>nie</span>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            }

            @if (Input.ContractType == ContractType.B2B)
            {
                <div class="form-group-row">
                    <div class="label-col"><span class="main-label">Składka ZUS<span class="req">*</span></span></div>
                    <div class="input-col">
                        <select class="form-select styled-select" @bind="Input.B2B_ZusType" @bind:after="Calculate">
                            <option value="@B2BZusType.UlgaNaStart">Brak składki ZUS ('Ulga na start')</option>
                            <option value="@B2BZusType.Preferencyjny">Preferencyjny ZUS (24 m-ce)</option>
                            <option value="@B2BZusType.Duzy">Pełny ZUS</option>
                        </select>
                    </div>
                </div>

                <div class="form-group-row">
                    <div class="label-col"><span class="main-label">Podatek dochodowy<span class="req">*</span></span></div>
                    <div class="input-col">
                        <select class="form-select styled-select" @bind="Input.B2B_TaxType" @bind:after="Calculate">
                            <option value="@B2BTaxType.Linear">Liniowy (19%)</option>
                            <option value="@B2BTaxType.Scale">Skala podatkowa (12%, 32%)</option>
                            <option value="@B2BTaxType.LumpSum">Ryczałt</option>
                        </select>
                    </div>
                </div>

                @if (Input.B2B_TaxType == B2BTaxType.LumpSum)
                {
                    <div class="form-group-row">
                        <div class="label-col"><span class="main-label">Stawka ryczałtu<span class="req">*</span></span></div>
                        <div class="input-col">
                            <select class="form-select styled-select" @bind="Input.B2B_LumpSumRate" @bind:after="Calculate">
                                <option value="0.17">17%</option>
                                <option value="0.15">15%</option>
                                <option value="0.14">14%</option>
                                <option value="0.12">12%</option>
                                <option value="0.10">10%</option>
                                <option value="0.085">8,5%</option>
                                <option value="0.055">5,5%</option>
                                <option value="0.03">3%</option>
                            </select>
                        </div>
                    </div>
                }

                <div class="form-group-row">
                    <div class="label-col"><span class="main-label">Dobrowolne ubezpieczenie chorobowe<span class="req">*</span></span></div>
                    <div class="input-col">
                        <div class="yes-no-toggle">
                            <div class="radio-option @(Input.B2B_ZusType == B2BZusType.UlgaNaStart ? "disabled" : "")"
                                 @onclick="() => { if (Input.B2B_ZusType != B2BZusType.UlgaNaStart) { Input.B2B_Sickness = true; Calculate(); } }">
                                <div class="custom-radio @(Input.B2B_Sickness ? "checked" : "")"><div class="dot"></div></div>
                                <span>tak</span>
                            </div>
                            <div class="radio-option @(Input.B2B_ZusType == B2BZusType.UlgaNaStart ? "disabled" : "")"
                                 @onclick="() => { if (Input.B2B_ZusType != B2BZusType.UlgaNaStart) { Input.B2B_Sickness = false; Calculate(); } }">
                                <div class="custom-radio @(!Input.B2B_Sickness ? "checked" : "")"><div class="dot"></div></div>
                                <span>nie</span>
                            </div>
                        </div>
                    </div>
                </div>
            }

            <hr class="divider" />

            @if (Input.ContractType == ContractType.UoP)
            {
                <div class="form-group-row">
                    <div class="label-col"><span class="main-label">Czy pracujesz w miejscu zamieszkania?<span class="req">*</span></span></div>
                    <div class="input-col">
                        <div class="yes-no-toggle">
                            <div class="radio-option" @onclick="() => { Input.UoP_WorkAtResidence = true; Calculate(); }">
                                <div class="custom-radio @(Input.UoP_WorkAtResidence ? "checked" : "")"><div class="dot"></div></div>
                                <span>tak</span>
                            </div>
                            <div class="radio-option" @onclick="() => { Input.UoP_WorkAtResidence = false; Calculate(); }">
                                <div class="custom-radio @(!Input.UoP_WorkAtResidence ? "checked" : "")"><div class="dot"></div></div>
                                <span>nie</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-group-row">
                    <div class="label-col">
                        <span class="main-label">Ulga dla osób poniżej 26. roku życia<span class="req">*</span></span>
                        <span class="sub-label">(zerowy PIT)</span>
                    </div>
                    <div class="input-col">
                        <div class="yes-no-toggle">
                            <div class="radio-option" @onclick="() => { Input.IsUnder26 = true; Calculate(); }">
                                <div class="custom-radio @(Input.IsUnder26 ? "checked" : "")"><div class="dot"></div></div>
                                <span>tak</span>
                            </div>
                            <div class="radio-option" @onclick="() => { Input.IsUnder26 = false; Calculate(); }">
                                <div class="custom-radio @(!Input.IsUnder26 ? "checked" : "")"><div class="dot"></div></div>
                                <span>nie</span>
                            </div>
                        </div>
                    </div>
                </div>
            }

            @if (Input.ContractType == ContractType.Zlecenie)
            {

                <div class="form-group-row">
                    <div class="label-col">
                        <span class="main-label">Ulga dla osób poniżej 26. roku życia<span class="req">*</span></span>
                    </div>
                    <div class="input-col">
                        <div class="yes-no-toggle">
                            <div class="radio-option" @onclick="() => { Input.IsUnder26 = true; Calculate(); }">
                                <div class="custom-radio @(Input.IsUnder26 ? "checked" : "")"><div class="dot"></div></div>
                                <span>tak</span>
                            </div>
                            <div class="radio-option" @onclick="() => { Input.IsUnder26 = false; Calculate(); }">
                                <div class="custom-radio @(!Input.IsUnder26 ? "checked" : "")"><div class="dot"></div></div>
                                <span>nie</span>
                            </div>
                        </div>
                    </div>
                </div>
            }

            @if (Input.ContractType == ContractType.Dzielo)
            {
                <div class="form-group-row">
                    <div class="label-col">
                        <span class="main-label">Koszt uzyskania przychodu<span class="req">*</span></span>
                    </div>
                    <div class="input-col">
                        <select class="form-select styled-select" @bind="Input.KupPercent" @bind:after="Calculate">
                            <option value="0,2">20% (Standard)</option>
                            <option value="0,5">50% (Prawa autorskie)</option>
                        </select>
                    </div>
                </div>
            }

            @if (Input.ContractType == ContractType.B2B)
            {
                <div class="form-group-row">
                    <div class="label-col"><span class="main-label">Koszty uzyskania przychodu</span></div>
                    <div class="input-col">
                        <div class="input-group">
                            <input type="number" @bind="Input.B2B_Costs" @bind:event="oninput" @onkeyup="Calculate" class="form-control text-end" placeholder="0" />
                            <span class="input-group-text currency-text">zł</span>
                        </div>
                    </div>
                </div>
            }

            <div class="bottom-action">
                <button class="btn-oblicz-bottom" @onclick="Calculate">Oblicz</button>
            </div>

        </div>

        @if (Result != null)
        {
            <div class="result-box">
                <div class="result-amount">@Result.Net.ToString("N2") <small>zł</small></div>
                <div class="result-label">netto (na rękę)</div>
                <div class="result-annual">wynagrodzenie roczne: @((Result.Net * 12).ToString("N2")) zł netto (na rękę)</div>
            </div>
        }

    </div>
</div>

<style>
    /* ========== STYLES ========== */
    :root {
        --primary-blue: #536be1;
        --text-dark: #191919;
        --text-grey: #6e6e6e;
        --border-color: #e4e6ea;
        --bg-color: #f7f9fa;
        --active-tab-border: #536be1;
        --active-tab-bg: #eff2ff;
        --active-tab-text: #3d52b9;
    }

    .pracuj-wrapper {
        font-family: 'Open Sans', 'Segoe UI', sans-serif;
        background-color: var(--bg-color);
        padding: 40px;
        display: flex;
        justify-content: center;
    }

    .calculator-card {
        background: #fff;
        width: 100%;
        max-width: 900px;
        border-radius: 8px;
        padding: 40px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }

    .calc-title {
        font-size: 24px;
        font-weight: 700;
        color: var(--text-dark);
        margin-bottom: 25px;
    }

    /* TOP BAR */
    .top-bar {
        display: flex;
        align-items: flex-end;
        gap: 20px;
        margin-bottom: 30px;
    }

    .amount-container {
        flex: 1;
    }

    .small-label {
        font-size: 13px;
        color: var(--text-grey);
        margin-bottom: 5px;
        display: block;
    }

    .custom-input-group {
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 5px;
        display: flex;
        align-items: center;
    }

    .amount-input {
        border: none;
        font-size: 18px;
        font-weight: 600;
        text-align: right;
        padding-right: 10px;
    }

        .amount-input:focus {
            box-shadow: none;
        }

    .currency-text {
        background: transparent;
        border: none;
        font-weight: 600;
        color: var(--text-grey);
    }

    .toggle-container {
        display: flex;
        gap: 20px;
        padding-bottom: 12px;
    }

    .btn-oblicz-top {
        background-color: var(--primary-blue);
        color: white;
        border: none;
        border-radius: 25px;
        padding: 10px 40px;
        font-weight: 700;
        height: 48px;
    }

        .btn-oblicz-top:hover {
            background-color: #3d52b9;
        }

    /* TABS */
    .tabs-row {
        display: flex;
        border: 1px solid var(--border-color);
        border-radius: 30px;
        overflow: hidden;
        margin-bottom: 30px;
    }

    .tab-btn {
        flex: 1;
        background: white;
        border: none;
        padding: 15px 0;
        font-weight: 600;
        color: var(--text-grey);
        cursor: pointer;
        transition: all 0.2s;
        border-right: 1px solid var(--border-color);
    }

        .tab-btn:last-child {
            border-right: none;
        }

        .tab-btn:hover {
            background-color: #f9f9f9;
        }

        .tab-btn.active {
            color: var(--active-tab-text);
            background-color: var(--active-tab-bg);
            border-bottom: 3px solid var(--active-tab-border);
        }

    /* FORM ROWS */
    .form-container {
        background-color: #fcfcfc;
        border: 1px solid #f0f0f0;
        border-radius: 8px;
        padding: 30px;
    }

    .form-group-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        flex-wrap: wrap;
    }

    .label-col {
        flex: 1;
        min-width: 250px;
    }

    .input-col {
        flex: 0 0 350px;
        text-align: right;
    }

    .main-label {
        font-weight: 600;
        color: var(--text-dark);
        font-size: 15px;
    }

    .req {
        color: #e03616;
        margin-left: 3px;
    }

    .sub-label {
        display: block;
        font-size: 12px;
        color: #999;
        margin-top: 3px;
    }

    /* RADIO CUSTOM */
    .yes-no-toggle {
        display: flex;
        gap: 30px;
        justify-content: flex-start;
    }

    .radio-option {
        display: flex;
        align-items: center;
        cursor: pointer;
        font-size: 15px;
        color: var(--text-dark);
    }

        .radio-option.disabled {
            opacity: 0.5;
            pointer-events: none;
        }

    .custom-radio {
        width: 20px;
        height: 20px;
        border: 2px solid #ccc;
        border-radius: 50%;
        margin-right: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }

        .custom-radio.checked {
            border-color: var(--primary-blue);
        }

        .custom-radio .dot {
            width: 10px;
            height: 10px;
            background-color: var(--primary-blue);
            border-radius: 50%;
            opacity: 0;
            transform: scale(0);
            transition: all 0.2s;
        }

        .custom-radio.checked .dot {
            opacity: 1;
            transform: scale(1);
        }

    .styled-select {
        padding: 10px;
        border-radius: 4px;
        border: 1px solid #ccc;
        width: 100%;
        background-color: white;
    }

    .divider {
        border-top: 1px solid #eee;
        margin: 20px 0 30px 0;
    }

    .bottom-action {
        text-align: center;
        margin-top: 30px;
    }

    .btn-oblicz-bottom {
        background: transparent;
        color: var(--primary-blue);
        border: 2px solid var(--primary-blue);
        padding: 10px 50px;
        border-radius: 25px;
        font-weight: 700;
        transition: all 0.2s;
    }

        .btn-oblicz-bottom:hover {
            background: var(--primary-blue);
            color: white;
        }

    /* RESULT */
    .result-box {
        margin-top: 40px;
        text-align: center;
        border-top: 1px solid #eee;
        padding-top: 30px;
    }

    .result-amount {
        font-size: 40px;
        font-weight: 800;
        color: var(--text-dark);
    }

    .result-label {
        font-size: 18px;
        font-weight: 700;
        color: var(--text-dark);
    }

    .result-annual {
        color: var(--text-grey);
        margin-top: 10px;
        font-size: 14px;
    }

    @@media(max-width: 768px) {
        .top-bar {
            flex-direction: column;
            align-items: stretch;
        }

        .form-group-row {
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
        }

        .input-col {
            width: 100%;
            text-align: left;
        }

        .tabs-row {
            flex-direction: column;
            border-radius: 8px;
        }

        .tab-btn {
            border-right: none;
            border-bottom: 1px solid #eee;
        }
    }
</style>

@code {
    public enum AmountType { Gross, Net }
    public enum ContractType { UoP, Zlecenie, Dzielo, B2B }
    public enum ZlecenieStatus { Standard, EmployedElsewhere, StudentUnder26 }
    public enum B2BZusType { UlgaNaStart, Preferencyjny, Duzy }
    public enum B2BTaxType { Linear, Scale, LumpSum }

    [SupplyParameterFromForm]
    public SalaryInput Input { get; set; } = new();
    public CalculationResult? Result;

    public class SalaryInput
    {
        [Required] public decimal Amount { get; set; } = 5000;
        public AmountType AmountType { get; set; } = AmountType.Gross;
        public ContractType ContractType { get; set; } = ContractType.UoP;
        public bool IsFixedSalary { get; set; } = true;

        // UoP
        public bool UoP_JointTaxation { get; set; } = false;
        public decimal AccidentRate { get; set; } = 1.67m;
        public bool UsePPK { get; set; } = false;
        public bool UoP_WorkAtResidence { get; set; } = true;
        public bool IsUnder26 { get; set; } = false;

        // Zlecenie
        public ZlecenieStatus Zlecenie_Status { get; set; } = ZlecenieStatus.Standard;
        public bool Zlecenie_Sickness { get; set; } = false;
        public decimal KupPercent { get; set; } = 0.2m; // Unified KUP for Zlecenie and Dzielo

        // B2B
        public B2BZusType B2B_ZusType { get; set; } = B2BZusType.UlgaNaStart;
        public B2BTaxType B2B_TaxType { get; set; } = B2BTaxType.Linear;
        public decimal B2B_LumpSumRate { get; set; } = 0.12m;
        public bool B2B_Sickness { get; set; } = false;
        public decimal B2B_Costs { get; set; } = 0;
    }

    public class CalculationResult
    {
        public decimal Gross { get; set; }
        public decimal Net { get; set; }
        public decimal EmployeeZusTotal { get; set; }
        public decimal HealthContribution { get; set; }
        public decimal Tax { get; set; }
        public decimal Expenses { get; set; }
    }

    private static class Rates
    {
        public const decimal Pension = 0.0976m;
        public const decimal Disability = 0.015m;
        public const decimal Sickness = 0.0245m;
        public const decimal HealthUoP = 0.09m;
        public const decimal TaxRate = 0.12m;
        public const decimal TaxRelief = 300m;
        public const decimal MinWage = 4300m;
        public const decimal B2B_Base_Duzy = 4694.40m;
        public const decimal B2B_Base_Pref = 1290m;
    }

    private void SetContract(ContractType type)
    {
        Input.ContractType = type;
        Calculate();
    }

    private void UpdateAmountType(AmountType type)
    {
        Input.AmountType = type;
        Calculate();
    }

    private void OnAmountChange(ChangeEventArgs e)
    {
        // Optional: debounce or react immediately
    }

    private void Calculate()
    {
        decimal gross = Input.Amount;
        if (Input.AmountType == AmountType.Net) gross = FindGross(Input.Amount);

        Result = Input.ContractType switch
        {
            ContractType.UoP => CalculateUoP(gross),
            ContractType.Zlecenie => CalculateZlecenie(gross),
            ContractType.Dzielo => CalculateDzielo(gross),
            ContractType.B2B => CalculateB2B(gross),
            _ => null
        };
    }

    private CalculationResult CalculateUoP(decimal gross)
    {
        var r = new CalculationResult { Gross = gross };

        decimal zus = gross * (Rates.Pension + Rates.Disability + Rates.Sickness);
        if (Input.UsePPK) zus += gross * 0.02m;
        r.EmployeeZusTotal = Math.Round(zus, 2);

        decimal socialOnly = gross * (Rates.Pension + Rates.Disability + Rates.Sickness);
        decimal healthBase = gross - socialOnly;
        r.HealthContribution = Math.Round(healthBase * Rates.HealthUoP, 2);

        decimal kup = Input.UoP_WorkAtResidence ? 250m : 300m;
        decimal taxBase = gross - socialOnly - kup;
        if (Input.UsePPK) taxBase += (gross * 0.015m);

        decimal tax = (taxBase * Rates.TaxRate) - Rates.TaxRelief;
        if (Input.IsUnder26) tax = 0;

        r.Tax = Math.Max(0, Math.Round(tax));
        decimal ppkPart = Input.UsePPK ? gross * 0.02m : 0;
        r.Net = gross - socialOnly - r.HealthContribution - r.Tax - ppkPart;

        return r;
    }

    private CalculationResult CalculateZlecenie(decimal gross)
    {
        var r = new CalculationResult { Gross = gross };
        if (Input.Zlecenie_Status == ZlecenieStatus.StudentUnder26) { r.Net = gross; return r; }

        bool fullZus = Input.Zlecenie_Status == ZlecenieStatus.Standard;
        decimal social = 0;
        if (fullZus)
        {
            social = gross * (Rates.Pension + Rates.Disability);
            if (Input.Zlecenie_Sickness) social += gross * Rates.Sickness;
        }
        r.EmployeeZusTotal = Math.Round(social, 2);

        decimal healthBase = gross - social;
        r.HealthContribution = Math.Round(healthBase * Rates.HealthUoP, 2);

        decimal kup = (gross - social) * Input.KupPercent;
        decimal taxBase = gross - social - kup;
        decimal tax = taxBase * Rates.TaxRate;
        if (Input.IsUnder26 && Input.Zlecenie_Status != ZlecenieStatus.Standard) tax = 0;

        r.Tax = Math.Max(0, Math.Round(tax));
        r.Net = gross - social - r.HealthContribution - r.Tax;
        return r;
    }

    private CalculationResult CalculateDzielo(decimal gross)
    {
        var r = new CalculationResult { Gross = gross };
        // Umowa o dzieło:
        // Brak ZUS, Brak Zdrowotnej.
        // Tylko podatek. KUP 20% lub 50%.

        decimal kupAmount = gross * Input.KupPercent;
        decimal taxBase = gross - kupAmount;

        decimal tax = taxBase * Rates.TaxRate;
        r.Tax = Math.Max(0, Math.Round(tax));

        r.Net = gross - r.Tax;
        return r;
    }

    private CalculationResult CalculateB2B(decimal gross)
    {
        var r = new CalculationResult { Gross = gross };
        r.Expenses = Input.B2B_Costs;

        decimal baseZus = Input.B2B_ZusType == B2BZusType.Duzy ? Rates.B2B_Base_Duzy :
                          (Input.B2B_ZusType == B2BZusType.Preferencyjny ? Rates.B2B_Base_Pref : 0);

        decimal social = 0;
        if (Input.B2B_ZusType != B2BZusType.UlgaNaStart)
        {
            social = baseZus * (Rates.Pension + Rates.Disability);
            if (Input.B2B_Sickness) social += baseZus * Rates.Sickness;
            if (Input.B2B_ZusType == B2BZusType.Duzy) social += baseZus * 0.0245m;
        }
        r.EmployeeZusTotal = Math.Round(social, 2);

        decimal income = gross - social - Input.B2B_Costs;
        decimal health = 0;

        if (Input.B2B_TaxType == B2BTaxType.Linear) health = Math.Max(Rates.MinWage * 0.09m, income * 0.049m);
        else if (Input.B2B_TaxType == B2BTaxType.Scale) health = Math.Max(0, income * 0.09m);
        else health = (gross * 12 < 60000) ? 419.46m : 699.11m;

        r.HealthContribution = Math.Round(health, 2);

        decimal tax = 0;
        if (Input.B2B_TaxType == B2BTaxType.Linear) tax = (income - Math.Min(health, 11600 / 12)) * 0.19m;
        else if (Input.B2B_TaxType == B2BTaxType.Scale) tax = (income * 0.12m) - 300m;
        else
        {
            decimal ded = social + (health * 0.5m);
            tax = (gross - ded) * Input.B2B_LumpSumRate;
        }
        r.Tax = Math.Max(0, Math.Round(tax));

        r.Net = gross - social - r.HealthContribution - r.Tax - Input.B2B_Costs;
        return r;
    }

    private decimal FindGross(decimal net)
    {
        decimal l = net, h = net * 2;
        for (int i = 0; i < 20; i++)
        {
            decimal mid = (l + h) / 2;
            decimal res = 0;
            if (Input.ContractType == ContractType.Dzielo) res = CalculateDzielo(mid).Net;
            else if (Input.ContractType == ContractType.Zlecenie) res = CalculateZlecenie(mid).Net;
            else if (Input.ContractType == ContractType.B2B) res = CalculateB2B(mid).Net;
            else res = CalculateUoP(mid).Net;

            if (res < net) l = mid; else h = mid;
        }
        return h;
    }
}