@page "/chat"
@rendermode InteractiveServer
@using System.Security.Claims
@using JobSearch.Data
@using JobSearch.Services
@using Microsoft.AspNetCore.Authorization
@inject ChatService ChatService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager NavManager
@inject IJSRuntime JSRuntime
@implements IDisposable
@attribute [Authorize]

<PageTitle>Wiadomości</PageTitle>

<div class="page-container">
    <div class="chat-layout-wrapper animate-fade-up">

        <div class="chat-sidebar">
            <div class="sidebar-header">
                <h5 class="m-0 fw-bold text-light">Wiadomości</h5>
            </div>

            <div class="conversations-list">
                @if (!chatPartners.Any())
                {
                    <div class="empty-sidebar">
                        <i class="bi bi-chat-square-dots"></i>
                        <p>Brak rozpoczętych rozmów.</p>
                    </div>
                }

                @foreach (var user in chatPartners)
                {
                    <div class="conversation-item @(selectedUserId == user.Id ? "active" : "")"
                         @onclick="() => SelectUser(user)">

                        <div class="avatar-circle">
                            @GetInitials(GetDisplayName(user))
                        </div>

                        <div class="conversation-info">
                            <div class="user-name">@GetDisplayName(user)</div>
                            <div class="user-status text-truncate">@user.Email</div>
                        </div>

                        @if (selectedUserId == user.Id)
                        {
                            <div class="active-indicator"></div>
                        }
                    </div>
                }
            </div>
        </div>

        <div class="chat-main">
            @if (selectedUser != null)
            {
                <div class="chat-header">
                    <div class="d-flex align-items-center">
                        <div class="avatar-circle small me-3">
                            @GetInitials(GetDisplayName(selectedUser))
                        </div>
                        <div>
                            <div class="chat-user-name">@GetDisplayName(selectedUser)</div>

                            <div class="chat-user-status">
                                @if (IsUserOnline(selectedUser.Id))
                                {
                                    <div class="status-dot online"></div>
                                    <span class="text-success fw-bold" style="font-size: 0.8rem;">Dostępny</span>
                                }
                                else
                                {
                                    <div class="status-dot offline"></div>
                                    <span class="text-danger fw-bold" style="font-size: 0.8rem;">Niedostępny</span>
                                }
                            </div>
                        </div>
                    </div>
                </div>

                <div class="messages-area" id="messagesBox">
                    @if (!messages.Any())
                    {
                        <div class="empty-chat-placeholder">
                            <i class="bi bi-chat-heart"></i>
                            <p>To początek Waszej rozmowy.</p>
                        </div>
                    }

                    @foreach (var msg in messages)
                    {
                        var isMe = msg.SenderId == currentUserId;

                        <div class="message-row @(isMe ? "message-out" : "message-in")">
                            @if (!isMe)
                            {
                                <div class="message-avatar-spacer">
                                    @GetInitials(GetDisplayName(selectedUser))
                                </div>
                            }

                            <div class="message-bubble animate-pop">
                                <div class="message-text">@msg.Message</div>
                                <div class="message-time">@msg.Timestamp.ToLocalTime().ToString("HH:mm")</div>
                            </div>
                        </div>
                    }
                </div>

                <div class="chat-input-area">
                    <div class="input-wrapper">
                        <input @bind="newMessageInput"
                               @bind:event="oninput"
                               @onkeyup="HandleEnter"
                               class="chat-input-field"
                               placeholder="Napisz wiadomość..." />

                        <button class="btn-send @(!string.IsNullOrWhiteSpace(newMessageInput) ? "ready" : "")"
                                @onclick="SendMessage">
                            WYŚLIJ
                        </button>
                    </div>
                </div>
            }
            else
            {
                <div class="no-chat-selected">
                    <div class="no-chat-content animate-fade-up">
                        <div class="icon-circle">
                            <i class="bi bi-chat-dots-fill"></i>
                        </div>
                        <h3>Witaj w komunikatorze</h3>
                        <p>Wybierz osobę z listy po lewej stronie, aby rozpocząć rozmowę.</p>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

<script>
    window.scrollToBottom = (id) => {
        var element = document.getElementById(id);
        if (element) {
            element.scrollTop = element.scrollHeight;
        }
    }
</script>

@code {
    private string? currentUserId;
    private List<ApplicationUser> chatPartners = new();
    private ApplicationUser? selectedUser;
    private string? selectedUserId;
    private List<ChatMessage> messages = new();
    private string newMessageInput = "";

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            currentUserId = authState.User.FindFirstValue(ClaimTypes.NameIdentifier);

            if (!string.IsNullOrEmpty(currentUserId))
            {
                chatPartners = await ChatService.GetChatPartnersAsync(currentUserId);
                ChatService.OnMessageSent += HandleNewMessage;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Błąd inicjalizacji czatu: {ex.Message}");
        }
    }

    private async void HandleNewMessage(string senderId, string receiverId)
    {
        try
        {
            if (selectedUser != null &&
                ((senderId == selectedUser.Id && receiverId == currentUserId) ||
                 (senderId == currentUserId && receiverId == selectedUser.Id)))
            {
                await InvokeAsync(async () =>
                {
                    await LoadMessages();
                    StateHasChanged();
                });
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Błąd w HandleNewMessage: {ex.Message}");
        }
    }

    private async Task SelectUser(ApplicationUser user)
    {
        try
        {
            selectedUser = user;
            selectedUserId = user.Id;
            messages = new List<ChatMessage>();
            await LoadMessages();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Błąd podczas wybierania użytkownika: {ex.Message}");
        }
    }

    private async Task LoadMessages()
    {
        if (currentUserId != null && selectedUserId != null)
        {
            try
            {
                messages = await ChatService.GetConversationAsync(currentUserId, selectedUserId);
                StateHasChanged();
                await Task.Delay(50);
                await JSRuntime.InvokeVoidAsync("scrollToBottom", "messagesBox");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Błąd ładowania wiadomości: {ex.Message}");
            }
        }
    }

    private async Task SendMessage()
    {
        if (!string.IsNullOrWhiteSpace(newMessageInput) && currentUserId != null && selectedUserId != null)
        {
            try
            {
                await ChatService.SendMessageAsync(currentUserId, selectedUserId, newMessageInput);
                newMessageInput = "";
                StateHasChanged();
                await Task.Delay(50);
                await JSRuntime.InvokeVoidAsync("scrollToBottom", "messagesBox");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Błąd wysyłania: {ex.Message}");
            }
        }
    }

    private async Task HandleEnter(KeyboardEventArgs e)
    {
        if (e.Key == "Enter") await SendMessage();
    }

    private string GetDisplayName(ApplicationUser? user)
    {
        if (user == null) return "Nieznany";
        if (!string.IsNullOrWhiteSpace(user.DisplayName)) return user.DisplayName;
        return user.Email ?? "Brak danych";
    }

    private string GetInitials(string? name)
    {
        if (string.IsNullOrWhiteSpace(name)) return "?";
        if (name.Contains("@"))
        {
            var localPart = name.Split('@')[0];
            var parts = localPart.Split(new[] { '.', '_', '-' }, StringSplitOptions.RemoveEmptyEntries);
            if (parts.Length >= 2)
                return $"{parts[0][0]}{parts[1][0]}".ToUpper();
            return localPart.Substring(0, Math.Min(2, localPart.Length)).ToUpper();
        }
        var nameParts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (nameParts.Length >= 2)
            return $"{nameParts[0][0]}{nameParts[1][0]}".ToUpper();
        return name.Substring(0, Math.Min(2, name.Length)).ToUpper();
    }

    private bool IsUserOnline(string userId)
    {
        // ZMIANA: Symulacja losowości opartej na ID użytkownika.
        // Jeśli HashCode jest parzysty -> Online, nieparzysty -> Offline.
        // Dzięki temu status jest stały dla danej osoby, ale różny między osobami.
        if (string.IsNullOrEmpty(userId)) return false;
        return Math.Abs(userId.GetHashCode()) % 2 == 0;
    }

    public void Dispose()
    {
        ChatService.OnMessageSent -= HandleNewMessage;
    }
}