@page "/Account/Manage/ResetAuthenticator"

@using Microsoft.AspNetCore.Identity
@using JobSearch.Data

@inject UserManager<ApplicationUser> UserManager
@inject SignInManager<ApplicationUser> SignInManager
@inject IdentityUserAccessor UserAccessor
@inject IdentityRedirectManager RedirectManager
@inject ILogger<ResetAuthenticator> Logger

<PageTitle>Resetowanie klucza uwierzytelniającego</PageTitle>

<div class="security-container">
    <h2 class="page-title">Resetowanie Klucza Authenticatora</h2>
    <p class="page-subtitle">Ostateczne rozwiązanie w przypadku utraty dostępu do aplikacji.</p>

    <StatusMessage />

    <div class="security-card reset-card">

        <div class="alert-danger custom-alert danger-warning" role="alert">
            <h4 class="alert-title">
                <i class="bi bi-exclamation-triangle-fill me-2"></i> WAŻNE OSTRZEŻENIE O BEZPIECZEŃSTWIE
            </h4>
            <p>
                <strong>Jeśli zresetujesz klucz uwierzytelniający, Twoja dotychczasowa aplikacja Authenticator przestanie działać.</strong>
            </p>
            <p>
                Ten proces **dezaktywuje 2FA** do momentu ponownej konfiguracji aplikacji. Jeśli nie ukończysz konfiguracji, możesz stracić dostęp do swojego konta.
            </p>
        </div>

        <div class="reset-action-area">
            <h5 class="reset-prompt">
                Czy na pewno chcesz zresetować klucz uwierzytelniający i wyłączyć 2FA?
            </h5>

            <form @formname="reset-authenticator" @onsubmit="OnSubmitAsync" method="post">
                <AntiforgeryToken />
                <button class="btn-security-danger large-button" type="submit">
                    <i class="bi bi-trash-fill me-2"></i> Zresetuj Klucz Authenticatora
                </button>
            </form>
        </div>
    </div>
</div>

@code {
    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;

    private async Task OnSubmitAsync()
    {
        var user = await UserAccessor.GetRequiredUserAsync(HttpContext);
        await UserManager.SetTwoFactorEnabledAsync(user, false);
        await UserManager.ResetAuthenticatorKeyAsync(user);
        var userId = await UserManager.GetUserIdAsync(user);
        Logger.LogInformation("User with ID '{UserId}' has reset their authentication app key.", userId);

        await SignInManager.RefreshSignInAsync(user);

        // ZMIANA TUTAJ: Polska, profesjonalna wiadomość
        RedirectManager.RedirectToWithStatus(
            "Account/Manage/EnableAuthenticator",
            "Klucz aplikacji uwierzytelniającej został pomyślnie zresetowany. Proszę skonfiguruj aplikację ponownie używając nowego klucza.",
            HttpContext);
    }
}