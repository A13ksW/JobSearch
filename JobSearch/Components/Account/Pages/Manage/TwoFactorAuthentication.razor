@page "/Account/Manage/TwoFactorAuthentication"

@using Microsoft.AspNetCore.Http.Features
@using Microsoft.AspNetCore.Identity
@using JobSearch.Data

@inject UserManager<ApplicationUser> UserManager
@inject SignInManager<ApplicationUser> SignInManager
@inject IdentityUserAccessor UserAccessor
@inject IdentityRedirectManager RedirectManager

<PageTitle>Two-factor authentication (2FA)</PageTitle>

<div class="security-container">
    <h2 class="page-title">Uwierzytelnianie Dwuskładnikowe (2FA)</h2>
    <p class="page-subtitle">Zwiększ bezpieczeństwo swojego konta.</p>

    <StatusMessage />

    @if (canTrack)
    {
        <div class="security-card">

            @if (is2faEnabled)
            {
                <h3 class="card-header-status enabled">
                    <i class="bi bi-shield-lock-fill me-2"></i> 2FA jest Włączone
                </h3>
            }
            else
            {
                <h3 class="card-header-status disabled">
                    <i class="bi bi-shield-slash-fill me-2"></i> 2FA jest Wyłączone
                </h3>
            }

            @if (is2faEnabled)
            {
                @if (recoveryCodesLeft == 0)
                {
                    <div class="alert alert-danger custom-alert">
                        <strong>Nie masz kodów odzyskiwania.</strong>
                        <p>Musisz <a href="Account/Manage/GenerateRecoveryCodes">wygenerować nowy zestaw kodów odzyskiwania</a>, zanim będziesz mógł zalogować się za pomocą kodu odzyskiwania.</p>
                    </div>
                }
                else if (recoveryCodesLeft <= 3)
                {
                    <div class="alert alert-warning custom-alert">
                        <strong>Pozostało @recoveryCodesLeft kodów odzyskiwania.</strong>
                        <p>Powinieneś <a href="Account/Manage/GenerateRecoveryCodes">wygenerować nowy zestaw kodów odzyskiwania</a>.</p>
                    </div>
                }

                @if (isMachineRemembered)
                {
                    <div class="action-row mt-4">
                        <span class="action-info">
                            <i class="bi bi-pc-display-horizontal me-2"></i>
                            Ten login jest zapamiętany.
                        </span>
                        <form @formname="forget-browser" @onsubmit="OnSubmitForgetBrowserAsync" method="post">
                            <AntiforgeryToken />
                            <button type="submit" class="btn-security-secondary">
                                <i class="bi bi-x-circle-fill me-1"></i> Zapomnij tę przeglądarkę
                            </button>
                        </form>
                    </div>
                }

                <div class="action-group mt-4 pt-4 border-top">
                    <a href="Account/Manage/GenerateRecoveryCodes" class="btn-security-action">
                        <i class="bi bi-arrow-clockwise me-1"></i> Zresetuj kody odzyskiwania
                    </a>
                    <a href="Account/Manage/Disable2fa" class="btn-security-danger ms-3">
                        <i class="bi bi-x-octagon-fill me-1"></i> Wyłącz 2FA
                    </a>
                </div>
            }

            <h4 class="section-title mt-5">Aplikacja Authenticator</h4>

            @if (!hasAuthenticator)
            {
                <div class="action-row">
                    <p class="action-info">Skonfiguruj aplikację, aby logować się kodami czasowymi.</p>
                    <a href="Account/Manage/EnableAuthenticator" class="btn-security-action">
                        <i class="bi bi-key-fill me-1"></i> Dodaj aplikację
                    </a>
                </div>
            }
            else
            {
                <div class="action-group">
                    <a href="Account/Manage/EnableAuthenticator" class="btn-security-action">
                        <i class="bi bi-gear-fill me-1"></i> Zmień konfigurację
                    </a>
                    <a href="Account/Manage/ResetAuthenticator" class="btn-security-secondary ms-3">
                        <i class="bi bi-trash-fill me-1"></i> Zresetuj aplikację
                    </a>
                </div>
            }
        </div>
    }
    else
    {
        <div class="alert alert-danger custom-alert">
            <strong>Polityka prywatności i plików cookie nie została zaakceptowana.</strong>
            <p>Musisz zaakceptować politykę, zanim będziesz mógł włączyć uwierzytelnianie dwuskładnikowe.</p>
        </div>
    }
</div>

@code {
    private bool canTrack;
    private bool hasAuthenticator;
    private int recoveryCodesLeft;
    private bool is2faEnabled;
    private bool isMachineRemembered;

    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        var user = await UserAccessor.GetRequiredUserAsync(HttpContext);
        canTrack = HttpContext.Features.Get<ITrackingConsentFeature>()?.CanTrack ?? true;
        hasAuthenticator = await UserManager.GetAuthenticatorKeyAsync(user) is not null;
        is2faEnabled = await UserManager.GetTwoFactorEnabledAsync(user);
        isMachineRemembered = await SignInManager.IsTwoFactorClientRememberedAsync(user);
        recoveryCodesLeft = await UserManager.CountRecoveryCodesAsync(user);
    }

    private async Task OnSubmitForgetBrowserAsync()
    {
        await SignInManager.ForgetTwoFactorClientAsync();

        RedirectManager.RedirectToCurrentPageWithStatus(
            "The current browser has been forgotten. When you login again from this browser you will be prompted for your 2fa code.",
            HttpContext);
    }
}