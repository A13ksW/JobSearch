@page "/Account/Manage"

@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Identity
@using JobSearch.Data
@using System.Security.Claims
@using System.Text.RegularExpressions

@inject UserManager<ApplicationUser> UserManager
@inject SignInManager<ApplicationUser> SignInManager
@inject IdentityUserAccessor UserAccessor
@inject IdentityRedirectManager RedirectManager
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>Profil</PageTitle>

<div class="profile-dashboard">

    <div class="page-header-center mb-5">
        <h2 class="header-title">Profil użytkownika</h2>
        <p class="header-subtitle">Zarządzaj swoimi danymi osobowymi i widocznością</p>
    </div>

    <StatusMessage />

    @if (user == null)
    {
        <div class="d-flex justify-content-center align-items-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Ładowanie...</span>
            </div>
        </div>
    }
    else
    {
        <div class="row g-4 justify-content-center">

            <!-- LEWA KOLUMNA -->
            <div class="col-lg-4">
                <div class="card-glass profile-summary h-100">
                    <div class="profile-bg-pattern"></div>
                    <div class="profile-content-wrapper">
                        <div class="profile-avatar-large">
                            @GetInitials(Input.DisplayName ?? user.Email)
                        </div>
                        <h4 class="mt-3 fw-bold text-center text-dark">@(Input.DisplayName ?? "Użytkownik")</h4>
                        <p class="text-muted text-center mb-4 small">@user.Email</p>

                        <div class="profile-badges">
                            <span class="badge-role">
                                @if (isCompany)
                                {
                                    <i class="bi bi-building"></i> <span>Konto Firmowe</span>
                                }
                                else
                                {
                                    <i class="bi bi-person"></i> <span>Konto Indywidualne</span>
                                }
                            </span>
                            <span class="badge-status">
                                <i class="bi bi-check-circle-fill"></i> <span>Aktywne</span>
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PRAWA KOLUMNA -->
            <div class="col-lg-8">
                <div class="card-glass h-100 p-5">

                    <div class="text-center mb-5 border-bottom pb-4">
                        <h5 class="card-title m-0 fw-bold text-dark mb-2">Dane podstawowe</h5>
                        <small class="text-muted d-block">Uzupełnij informacje, aby inni mogli Cię znaleźć</small>
                    </div>

                    <EditForm Model="Input" FormName="profile" OnValidSubmit="OnValidSubmitAsync" method="post">
                        <DataAnnotationsValidator />

                        <div class="row g-4">

                            <!-- Imię i Nazwisko lub Nazwa Firmy -->
                            <div class="col-12">
                                <div class="modern-input-group centered-input">

                                    <div class="input-icon-top">
                                        @if (isCompany)
                                        {
                                            <i class="bi bi-building" style="font-size: 26px;"></i>
                                        }
                                        else
                                        {
                                            <i class="bi bi-person-fill" style="font-size: 28px;"></i>
                                        }
                                    </div>

                                    <label for="display-name" class="modern-label text-center w-100">
                                        @(isCompany ? "Nazwa Firmy" : "Imię i Nazwisko")
                                    </label>

                                    <InputText @bind-Value="Input.DisplayName"
                                               id="display-name"
                                               class="modern-input text-center"
                                               placeholder="@(isCompany ? "Wpisz nazwę firmy" : "Jan Kowalski")" />
                                </div>

                                <div class="text-center">
                                    <ValidationMessage For="() => Input.DisplayName" class="text-danger small mt-1" />
                                </div>
                            </div>

                            <!-- Numer telefonu -->
                            <div class="col-12">
                                <div class="modern-input-group centered-input">
                                    <div class="input-icon-top">
                                        <i class="bi bi-telephone-fill" style="font-size: 24px;"></i>
                                    </div>

                                    <label for="phone-number" class="modern-label text-center w-100">Numer telefonu</label>
                                    <InputText @bind-Value="Input.PhoneNumber" id="phone-number"
                                               class="modern-input text-center" placeholder="123456789" />
                                </div>
                                <div class="text-center">
                                    <ValidationMessage For="() => Input.PhoneNumber" class="text-danger small mt-1" />
                                </div>
                            </div>

                        </div>

                        <div class="mt-5 d-flex justify-content-center">
                            <button type="submit" class="btn-save-pro w-50">
                                <span class="btn-content justify-content-center">
                                    <i class="bi bi-check-lg me-2"></i>
                                    Zapisz zmiany
                                </span>
                            </button>
                        </div>

                    </EditForm>

                </div>
            </div>

        </div>
    }
</div>

@code {
    private ApplicationUser? user;
    private string? phoneNumber;
    private bool isCompany = false;

    [CascadingParameter] private HttpContext HttpContext { get; set; } = default!;

    [SupplyParameterFromForm]
    private InputModel Input { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        user = await UserAccessor.GetRequiredUserAsync(HttpContext);
        if (user == null) return;

        phoneNumber = await UserManager.GetPhoneNumberAsync(user);

        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var principal = authState.User;

        // Poprawna detekcja firmy
        isCompany = principal.HasClaim(c => c.Type == "account_type" && c.Value == "Company");

        // Przekazanie do modelu walidacji
        Input.IsCompany = isCompany;

        Input.PhoneNumber ??= phoneNumber;
        Input.DisplayName ??= user.DisplayName;
    }

    private async Task OnValidSubmitAsync()
    {
        if (user == null) return;

        user.PhoneNumber = Input.PhoneNumber;
        user.DisplayName = Input.DisplayName ?? "";

        var updateResult = await UserManager.UpdateAsync(user);
        if (!updateResult.Succeeded)
        {
            RedirectManager.RedirectToCurrentPageWithStatus("Błąd: Nie udało się zaktualizować profilu.", HttpContext);
            return;
        }

        await SignInManager.RefreshSignInAsync(user);
        RedirectManager.RedirectToCurrentPageWithStatus("Twój profil został zaktualizowany", HttpContext);
    }

    private string GetInitials(string? name)
    {
        if (string.IsNullOrWhiteSpace(name)) return "A";
        if (name.Contains("@")) return name[0].ToString().ToUpper();

        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2)
            return $"{parts[0][0]}{parts[1][0]}".ToUpper();

        return name[..Math.Min(2, name.Length)].ToUpper();
    }

    private sealed class InputModel : IValidatableObject
    {
        public bool IsCompany { get; set; }

        [Required(ErrorMessage = "Numer telefonu jest wymagany.")]
        [RegularExpression(@"^\d{9}$", ErrorMessage = "Numer telefonu musi składać się z dokładnie 9 cyfr.")]
        public string? PhoneNumber { get; set; }

        [Required(ErrorMessage = "To pole jest wymagane.")]
        public string? DisplayName { get; set; }

        public IEnumerable<ValidationResult> Validate(ValidationContext context)
        {
            if (string.IsNullOrWhiteSpace(DisplayName))
                yield break;

            if (IsCompany)
            {
                if (DisplayName.Length < 2)
                {
                    yield return new ValidationResult(
                        "Nazwa firmy musi mieć co najmniej 2 znaki.",
                        new[] { nameof(DisplayName) });
                }
            }
            else
            {
                // Dokładnie dwa słowa, tylko litery Unicode
                var regex = new Regex(@"^[\p{L}]+ [\p{L}]+$");

                if (!regex.IsMatch(DisplayName))
                {
                    yield return new ValidationResult(
                        "Wpisz poprawne Imię i Nazwisko (dwa słowa, wyłącznie litery, oddzielone spacją).",
                        new[] { nameof(DisplayName) });
                }
            }
        }
    }
}
