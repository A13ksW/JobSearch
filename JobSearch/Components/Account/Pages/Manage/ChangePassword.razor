@page "/Account/Manage/ChangePassword"

@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Identity
@using JobSearch.Data

@inject UserManager<ApplicationUser> UserManager
@inject SignInManager<ApplicationUser> SignInManager
@inject IdentityUserAccessor UserAccessor
@inject IdentityRedirectManager RedirectManager
@inject ILogger<ChangePassword> Logger

<PageTitle>Zmiana hasła</PageTitle>

<div class="password-dashboard">

    <!-- NAGŁÓWEK STRONY -->
    <div class="page-header-center mb-5">
        <h2 class="header-title">Zmiana Hasła</h2>
        <p class="header-subtitle">Zadbaj o bezpieczeństwo swojego konta</p>
    </div>

    <StatusMessage Message="@message" />

    <div class="row justify-content-center">
        <div class="col-lg-8 col-md-10">
            <!-- KARTA GLASS -->
            <div class="card-glass p-5">

                <!-- IKONA KŁÓDKI NA GÓRZE -->
                <div class="password-icon-section mb-5">
                    <div class="icon-circle-large">
                        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" fill="currentColor" class="bi bi-shield-lock-fill" viewBox="0 0 16 16">
                            <path fill-rule="evenodd" d="M8 0c-.69 0-1.843.265-2.928.56-1.11.3-2.229.655-2.887.87a1.54 1.54 0 0 0-1.044 1.262c-.596 4.477.787 7.795 2.465 9.99a11.777 11.777 0 0 0 2.517 2.453c.386.273.744.482 1.048.625.28.132.581.24.829.24s.548-.108.829-.24a7.159 7.159 0 0 0 1.048-.625 11.775 11.775 0 0 0 2.517-2.453c1.678-2.195 3.061-5.513 2.465-9.99a1.541 1.541 0 0 0-1.044-1.263 62.467 62.467 0 0 0-2.887-.87C9.843.266 8.69 0 8 0zm0 5a1.5 1.5 0 0 1 .5 2.915l.385 1.99a.5.5 0 0 1-.491.595h-.788a.5.5 0 0 1-.49-.595l.384-1.99A1.5 1.5 0 0 1 8 5z" />
                        </svg>
                    </div>
                </div>

                <!-- FORMULARZ (Czysty Blazor) -->
                <EditForm Model="Input" FormName="change-password" OnValidSubmit="OnValidSubmitAsync">
                    <DataAnnotationsValidator />

                    <!-- 1. OBECNE HASŁO -->
                    <div class="modern-input-group centered-input mb-4">
                        <div class="input-icon-top">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-key-fill" viewBox="0 0 16 16">
                                <path d="M3.5 11.5a3.5 3.5 0 1 1 3.163-5H14L15.5 8 14 9.5l-1-1-1 1-1-1-1 1-1-1-1 1H6.663a3.5 3.5 0 0 1-3.163 2zM2.5 9a1 1 0 1 0 0-2 1 1 0 0 0 0 2z" />
                            </svg>
                        </div>
                        <label class="modern-label text-center w-100">Obecne hasło</label>
                        <InputText type="password" @bind-Value="Input.OldPassword" class="modern-input text-center" autocomplete="current-password" aria-required="true" placeholder="••••••••" />
                    </div>
                    <div class="text-center mb-3">
                        <ValidationMessage For="() => Input.OldPassword" class="text-danger small fw-bold" />
                    </div>

                    <!-- 2. NOWE HASŁO -->
                    <div class="modern-input-group centered-input mb-4">
                        <div class="input-icon-top">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-unlock-fill" viewBox="0 0 16 16">
                                <path d="M11 1a2 2 0 0 0-2 2v4a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h5V3a3 3 0 0 1 6 0v4a.5.5 0 0 1-1 0V3a2 2 0 0 0-2-2z" />
                            </svg>
                        </div>
                        <label class="modern-label text-center w-100">Nowe hasło</label>
                        <InputText type="password" @bind-Value="Input.NewPassword" class="modern-input text-center" autocomplete="new-password" aria-required="true" placeholder="••••••••" />
                    </div>
                    <div class="text-center mb-3">
                        <ValidationMessage For="() => Input.NewPassword" class="text-danger small fw-bold" />
                    </div>

                    <!-- 3. POTWIERDŹ HASŁO -->
                    <div class="modern-input-group centered-input mb-4">
                        <div class="input-icon-top">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-check-circle-fill" viewBox="0 0 16 16">
                                <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z" />
                            </svg>
                        </div>
                        <label class="modern-label text-center w-100">Potwierdź nowe hasło</label>
                        <InputText type="password" @bind-Value="Input.ConfirmPassword" class="modern-input text-center" autocomplete="new-password" aria-required="true" placeholder="••••••••" />
                    </div>
                    <div class="text-center mb-4">
                        <ValidationMessage For="() => Input.ConfirmPassword" class="text-danger small fw-bold" />
                    </div>

                    <!-- PRZYCISK ZAKTUALIZUJ -->
                    <div class="d-flex justify-content-center mt-4">
                        <button type="submit" class="btn-save-pro large">
                            <span class="btn-content">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-arrow-repeat me-2" viewBox="0 0 16 16">
                                    <path d="M11.534 7h3.932a.25.25 0 0 1 .192.41l-1.966 2.36a.25.25 0 0 1-.384 0l-1.966-2.36a.25.25 0 0 1 .192-.41zm-11 2h3.932a.25.25 0 0 0 .192-.41L2.692 6.23a.25.25 0 0 0-.384 0L.342 8.59A.25.25 0 0 0 .534 9z" />
                                    <path fill-rule="evenodd" d="M8 3c-1.552 0-2.94.707-3.857 1.818a.5.5 0 1 1-.771-.636A6.002 6.002 0 0 1 13.917 7H12.9A5.002 5.002 0 0 0 8 3zM3.1 9a5.002 5.002 0 0 0 8.757 2.182.5.5 0 1 1 .771.636A6.002 6.002 0 0 1 2.083 9H3.1z" />
                                </svg>
                                Zaktualizuj hasło
                            </span>
                        </button>
                    </div>
                </EditForm>

            </div>
        </div>
    </div>
</div>

@code {
    private string? message;
    private ApplicationUser user = default!;
    private bool hasPassword;

    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;

    [SupplyParameterFromForm]
    private InputModel Input { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        user = await UserAccessor.GetRequiredUserAsync(HttpContext);
        hasPassword = await UserManager.HasPasswordAsync(user);
        if (!hasPassword)
        {
            RedirectManager.RedirectTo("Account/Manage/SetPassword");
        }
    }

    private async Task OnValidSubmitAsync()
    {
        var changePasswordResult = await UserManager.ChangePasswordAsync(user, Input.OldPassword, Input.NewPassword);
        if (!changePasswordResult.Succeeded)
        {
            // ZMIANA: Tłumaczenie błędów na język polski
            var errors = changePasswordResult.Errors.Select(e => TranslateError(e.Description)).ToList();
            message = $"Błąd: {string.Join(" ", errors)}";
            return;
        }

        await SignInManager.RefreshSignInAsync(user);
        Logger.LogInformation("User changed their password successfully.");

        RedirectManager.RedirectToCurrentPageWithStatus("Twoje hasło zostało zmienione pomyślnie.", HttpContext);
    }

    // Prosty helper do tłumaczenia komunikatów Identity
    private string TranslateError(string error)
    {
        if (error.Contains("Passwords must be at least 8 characters")) return "Hasło musi mieć co najmniej 8 znaków.";
        if (error.Contains("Passwords must have at least one non alphanumeric character")) return "Hasło musi zawierać znak specjalny (np. !, @, #).";
        if (error.Contains("Passwords must have at least one digit")) return "Hasło musi zawierać cyfrę.";
        if (error.Contains("Passwords must have at least one uppercase")) return "Hasło musi zawierać wielką literę.";
        if (error.Contains("Incorrect password")) return "Obecne hasło jest nieprawidłowe.";
        return error;
    }

    private sealed class InputModel
    {
        [Required(ErrorMessage = "Obecne hasło jest wymagane")]
        [DataType(DataType.Password)]
        [Display(Name = "Current password")]
        public string OldPassword { get; set; } = "";

        [Required(ErrorMessage = "Nowe hasło jest wymagane")]
        [StringLength(100, ErrorMessage = "Hasło musi mieć min. {2} i maks. {1} znaków.", MinimumLength = 8)]
        [DataType(DataType.Password)]
        [Display(Name = "New password")]
        public string NewPassword { get; set; } = "";

        [DataType(DataType.Password)]
        [Display(Name = "Confirm new password")]
        [Compare("NewPassword", ErrorMessage = "Hasła nie są identyczne.")]
        public string ConfirmPassword { get; set; } = "";
    }
}